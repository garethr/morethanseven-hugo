<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.21" />
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>More than seven &middot; More than seven</title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  
  
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="More than seven &middot; More than seven" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-435455-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-08">
<div class="sidebar">
  <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1><a href="/">More than seven</a></h1>
      <p class="lead">Writing about code. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2015/05/09/acceptance-testing-mirageos/">Acceptance testing MirageOS installs</a>
      </h1>
      <span class="post-date">May 9, 2015 &middot; 2 minute read
      </span>
      
      

<p>I&rsquo;m pretty interested in <a href="http://openmirage.org/">MirageOS</a> at the
moment. Partly because I find the idea behind unikernels interesting and
partly because I keep bumping into the nice folks <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/">OCaml
Labs</a> in Cambridge.</p>

<p>In order to write and build your MirageOS unikernel application you need
an OCaml development environment. Although this is
<a href="http://openmirage.org/wiki/install">documented</a> I wanted something a
little more repeatable. I also found and reported a few bugs in the
documentation which got me thinking about acceptance testing. I&rsquo;m not
(yet) an OCaml programmer, but infrastructure automation and testing I
can do.</p>

<h2 id="into-puppet">Into Puppet</h2>

<p>I started out writing a Puppet module to install and manage everything,
which is now available on
<a href="https://github.com/garethr/garethr-mirageos">GitHub</a> and on the
<a href="https://forge.puppetlabs.com/garethr/mirageos">Forge</a>.</p>

<p>This lets you do something like the following, and have a fully working
MirageOS setup on Ubuntu 12.04 or 14.04.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #008800; font-weight: bold">class</span> { <span style="color: #dd2200; background-color: #fff0f0">&#39;mirageos&#39;</span>:
  <span style="color: #008800; font-weight: bold">user</span>      =&gt; <span style="color: #dd2200; background-color: #fff0f0">&#39;vagrant&#39;</span>,
  <span style="color: #336699">opam_root</span> =&gt; <span style="color: #dd2200; background-color: #fff0f0">&#39;/home/vagrant/.opam&#39;</span>,
}
</pre></div>

<p>Given time, inclination or pull requests I&rsquo;ll add support for other
operating systems in the future.</p>

<h2 id="but-how-do-you-know-it-works">But how do you know it works?</h2>

<p>The module has a small unit test suite, but it&rsquo;s nice to know test the
actual running of Puppet and installation of the software. For this I&rsquo;ve
used <a href="http://kitchen.ci/">Test Kitchen</a> and
<a href="http://serverspec.org/">ServerSpec</a>. This allows for spinning up 2
virtual machines (one for each supported operating system), applying the
Puppet manifest and then making some assertions:</p>

<script src="//gist.github.com/garethr/a8d090b5d7f7a190f7d9.js"></script>

<p>The above is simply checking whether certain packages are installed, the
PPA is setup correctly and whether <code>mirage</code> and <code>opam</code> can be executed
cleanly.</p>

<h2 id="can-it-produce-a-working-unikernel">Can it produce a working unikernel?</h2>

<p>The above tells us whether the installation worked, but not whether the
resulting software allows us to build MirageOS unikernels. For this I
used <a href="https://github.com/sstephenson/bats">Bats</a> running in the same
Test Kitchen setup.</p>

<script src="//gist.github.com/garethr/191c4c0676b471f9b986.js"></script>

<p>The above configures and builds a simple HTTP server unikernel, and then
checks that when run it returns the expected response on the correct
port.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I like the separation of concerns above. I can use the Puppet code
without the test code, or even swap the Puppet code out for a shell
script if I wanted. I could also run the serverspec tests anywhere I
want to check state, which is the reason for separating those tests from
the one&rsquo;s building and running a unikernel. Overall the tool chain for ad-hoc
infrastructure testing (quick mention of
<a href="http://infrataster.net/">Infrataster</a> too) is really quite powerful and
approachable. I&rsquo;d love to see more software ship with a user-facing test
suite for people to verify their installation works.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2015/01/02/automating-windows-development-environments/">Automating windows development environments</a>
      </h1>
      <span class="post-date">Jan 2, 2015 &middot; 1 minute read
      </span>
      
      <p>My job at Puppet Labs has given me an excuse to take a closer look at
the advancements in Windows automation, in particular <a href="https://chocolatey.org/">Chocolatey</a>
and <a href="http://boxstarter.org/">BoxStarter</a>. The following is very much a work
in progress but it&rsquo;s hopefully useful for a few things:</p>

<ul>
<li>If like me you&rsquo;ve mainly been doing non-Windows development for a
while it&rsquo;s interesting to see what is possible</li>
<li>If you&rsquo;re starting out with infrastructure development on Windows the
following could be a good starting place</li>
<li>if you&rsquo;re an experienced Windows pro then you can let me know of any
improvements</li>
</ul>

<p>All that&rsquo;s needed is to run the following from a CMD or Powershell
prompt on a new Windows machine (you can also visit the URL in Internet
Explorer if you prefer).</p>

<pre><code>START http://boxstarter.org/package/nr/url?https://gist.githubusercontent.com/garethr/a1838aa68355a0766de4/raw/d92b41ee9dcad68c079d24c64bac7d1d27cf37c7/garethr.ps1
</code></pre>

<p>This launches BoxStarter, which executes the following code:</p>

<script src="//gist.github.com/garethr/a1838aa68355a0766de4.js"></script>

<p>This takes a while as it runs Windows update and repeatedly reboots the
machine. But once completed you&rsquo;ll have the listed software installed
and configured on a newly up-to-date Windows machine.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/10/28/docker-puppet-shared-volumes/">Docker, Puppet and shared volumes</a>
      </h1>
      <span class="post-date">Oct 28, 2014 &middot; 4 minute read
      </span>
      
      

<p>During one of the openspace sessions at Devopsdays we talked about docker and configuration management,
and one of the things we touched on was using dockers shared volumes support. This is easier to explain
with an example.</p>

<p>First, lets create a docker image to run puppet. I&rsquo;m also installing r10k for managing third party
modules.</p>

<h2 id="docker">Docker</h2>

<pre><code>FROM ubuntu:trusty

RUN apt-get update -q
RUN apt-get install -qy wget
RUN wget http://apt.puppetlabs.com/puppetlabs-release-trusty.deb
RUN dpkg -i puppetlabs-release-trusty.deb
RUN apt-get update

RUN apt-get install -y puppet ruby1.9.3 build-essential git-core
RUN echo &quot;gem: --no-ri --no-rdoc&quot; &gt; ~/.gemrc
RUN gem install r10k
</code></pre>

<p>Lets build that and tag it locally. Feel free to use whatever name you like here.</p>

<pre><code>docker build -t garethr/puppet .
</code></pre>

<p>Lets now use that image as a base for another image.</p>

<pre><code>FROM garethr/puppet

RUN mkdir /etc/shared
ADD Puppetfile /
RUN r10k puppetfile check
RUN r10k puppetfile install
ADD init.pp /
CMD [&quot;puppet&quot;, &quot;apply&quot;, &quot;--modulepath=/modules&quot;, &quot;/init.pp&quot;,&quot;--verbose&quot;, &quot;--show_diff&quot;]
</code></pre>

<p>This image will be used to create containers that we intend to run. Here we&rsquo;re including a
Puppetfile (a list of module dependencies) and then running r10k to download those dependencies.
Finally we add a simple puppetfile (this would likely be an entire manifests directory in most cases).
The final line means that when we run a container based on this image it will run puppet and then exit.</p>

<p>Again lets build the image and tag it.</p>

<pre><code>docker build -t garethr/puppetshared .
</code></pre>

<p>Just as a demo, here&rsquo;s a sample <code>Puppetfile</code> which includes the puppetlabs stdlib module.</p>

<h2 id="puppet">Puppet</h2>

<pre><code>mod 'puppetlabs/stdlib'
</code></pre>

<p>And again as an example here&rsquo;s a simple puppet <code>init.pp</code> file. All we&rsquo;re doing is creating a file
at a specific location.</p>

<pre><code>file { '/etc/shared/client':
  ensure =&gt; directory,
}

file { '/etc/shared/client/apache.conf':
  ensure  =&gt; present,
  content =&gt; &quot;not a real config file&quot;,
}
</code></pre>

<h2 id="fig">Fig</h2>

<p><a href="http://fig.sh">Fig</a> is a tool to declare container types in a text file, and then run and manage
them from a simple CLI. We could do all this with straigh docker calls too.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>master:
  image: garethr/puppetshared
  volumes:
    - /etc/shared:/etc/shared:rw

client:
  image: ubuntu:trusty
  volumes:
    - /etc/shared/client:/etc/:ro
  command: <span style="color: #dd2200; background-color: #fff0f0">&#39;/bin/sh</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">-c</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">&quot;while</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">true;</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">do</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">echo</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">hello</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">world;</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">sleep</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">1;</span><span style="color: #336699"> </span><span style="color: #dd2200; background-color: #fff0f0">done&quot;&#39;</span>
</pre></div>

<p>The important part of the above is the volumes lines. What we&rsquo;re doing here is:</p>

<ul>
<li>Sharing the <code>/etc/shared</code> directory on the host with the container called master. The container will be able to write to the host filesystem.</li>
<li>Sharing a subdirectory of of <code>/etc/shared</code> with the client container. The client can only read this information.</li>
</ul>

<p>Note the client container here isn&rsquo;t running Puppet. Here it&rsquo;s just running sleep in a loop to simulate a long running process like
your custom application.</p>

<p>Let&rsquo;s run the master. Note that this will run puppet and then exit. But with the above manifest it will create
a config file on the host.</p>

<pre><code>fig run master
</code></pre>

<p>Then run the client. This won&rsquo;t exit and should just print <code>hello world</code> to stdout.</p>

<pre><code>fig run client
</code></pre>

<p>Docker 1.3 adds the handy exec command, which allows for one-off commands to be executed within a running container.
Lets use that to see our new config file.</p>

<pre><code>docker exec puppetshared_client_run_1 cat /etc/apache.conf
</code></pre>

<p>This should output the contents of the file we created by running the master container.</p>

<h2 id="why">Why?</h2>

<p>This is obviously a very simple example but I think it&rsquo;s interesting for a few reasons.</p>

<ul>
<li>We have completely separated our code (in the container) from the configuration</li>
<li>We get to use familiar tools for managing the configuration in a familiar way</li>
</ul>

<p>It also raises a few problems:</p>

<ul>
<li>The host needs to know what types of container are going to run on it, in order to have the correct configuration. If you&rsquo;re using <a href="https://forge.puppetlabs.com/garethr/docker">Puppet module</a> then this is simple enough to solve.</li>
<li>The host ends up with all of the configuration for all the containers in one place, you could also do things with encrypting the data and having the relevant keys in one image and not others. Given how if you&rsquo;re on the host you own the container anyway this isn&rsquo;t as odd as it sounds.</li>
<li>We&rsquo;re just demonstrating files here, but if we change our manifest and rerun the puppet container then we change the config files. But depending on the application it  won&rsquo;t pick that up unless we restart it or create a new container.</li>
</ul>

<p>Given enough time I may try build a reference implementation using this approach, anyone with ideas about that let me know.</p>

<p>This post was inspired by a conversation with <a href="https://twitter.com/kelseyhightower">Kelsey</a> and <a href="http://twitter.com/botchagalupe">John</a>, thanks guys.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/10/12/using-puppet-with-key-value-config-stores/">Using Puppet with key/value config stores</a>
      </h1>
      <span class="post-date">Oct 12, 2014 &middot; 2 minute read
      </span>
      
      <p>I like the central idea behind storing configuration in something like
<a href="https://github.com/coreos/etcd">Etcd</a> rather than lots of files on lots
of disks, but a few challenges still remain. Things that spring to mind
are:</p>

<ul>
<li>Are all your passwords now available to all of your nodes?</li>
<li>How do I know when configuration changed and who changed it?</li>
</ul>

<p>I&rsquo;ll leave the first of those for today (although have a look at
<a href="http://www.conjur.net/">Conjur</a> as one approach to this). For the second,
I&rsquo;m quite fond of plain text, pull requests and a well tested deployment
pipeline. Before Etcd (or <a href="http://www.consul.io/">Consul</a> or similar) you
would probably have values in Hiera or Data Bags or similar and inject them
into files on hosts using your configuration management tool of choice. So
lets just do the same with our new-fangled distributed configuration store.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #336699">key_value_config</span> { <span style="color: #dd2200; background-color: #fff0f0">&#39;/foo&#39;</span>:
  <span style="color: #336699">ensure</span>   =&gt; <span style="color: #008800; font-weight: bold">present</span>,
  <span style="color: #336699">provider</span> =&gt; <span style="color: #336699">etcd</span>,
  <span style="color: #336699">value</span>    =&gt; <span style="color: #dd2200; background-color: #fff0f0">&#39;bar&#39;</span>,
}
</pre></div>

<p>Say you wanted to switch over to using Consul instead? Just switch the provider.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #336699">key_value_config</span> { <span style="color: #dd2200; background-color: #fff0f0">&#39;/foo&#39;</span>:
  <span style="color: #336699">ensure</span>   =&gt; <span style="color: #008800; font-weight: bold">present</span>,
  <span style="color: #336699">provider</span> =&gt; <span style="color: #336699">consul</span>,
  <span style="color: #336699">value</span>    =&gt; <span style="color: #dd2200; background-color: #fff0f0">&#39;bar&#39;</span>,
}
</pre></div>

<p>You&rsquo;d probably move all of that out into something like hiera, and then generate
the above resources, but you get the idea.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>etcd_values:
  foo: bar
</pre></div>

<p>The above is implemented in a very simple
<a href="https://github.com/garethr/garethr-key_value_config">proof of concept Puppet module</a>.
Anyone with any feedback please do let me know.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/07/20/leaving-gds-never-easy/">Leaving GDS never easy</a>
      </h1>
      <span class="post-date">Jul 20, 2014 &middot; 2 minute read
      </span>
      
      <p><em>The following is the email I sent to lots of my colleagues at the
<a href="https://gds.blog.gov.uk/">Government Digital Service</a> last week.</em></p>

<p>So, after 3 rather exciting years I&rsquo;ve decided to leave GDS.</p>

<p>That&rsquo;s surprisingly difficult to write if I&rsquo;m honest.</p>

<p>I was part of the team that built and shipped the beta of <a href="https://www.gov.uk">GOV.UK</a>.
Since then I&rsquo;ve worked across half of what has become GDS, equally
helping and frustrating (then hopefully helping) lots of you. I&rsquo;ve
done a great deal and learnt even more, as well as collected arcane
knowledge about government infosec and the dark arts of procurement
along the way. I&rsquo;ve done, and helped others do, work I wouldn&rsquo;t even
have thought possible (or maybe likely is the right word?) when I
started.</p>

<p>So why leave? For all the other things I do I&rsquo;m basically a tool
builder. So I&rsquo;m going off to work for <a href="http://puppetlabs.com">Puppet Labs</a> to build
infrastructure tools that don&rsquo;t suck. That sort of pretty specific
work is something that <em>should</em> be done outside government in my
opinion. I&rsquo;m a pretty firm believer in &ldquo;government should only do what
only government can do&rdquo; (<a href="https://www.gov.uk/design-principles#second">design principle number 2</a> for those that
haven&rsquo;t memorised them yet). And if I&rsquo;m honest, focusing on something
smaller than fixing a country&rsquo;s civic infrastructure is appealing for
now.</p>

<p>I&rsquo;ll let you in on a secret; I didn&rsquo;t join what became GDS because of
the GOV.UK project. I joined to work with friends I&rsquo;d not yet had the
chance to work with and to see the inside of a growing organisation
from the start. I remember <a href="http://twitter.com/tomskitomski">Tom Loosemore</a> promising me we&rsquo;d be 200
people in 3 years! As far as anyone knows we&rsquo;re 650+ people. That&rsquo;s
about a person a day for 2 years. I&rsquo;m absolutely not saying that came
without a cost, but for me being part of that that was part of the
point - so I can be a little accepting with hindsight.</p>

<p>For me, apart from all the short term things (side-note: this job now
has me thinking £10million is a small amount of money and 2 years is a
small amount of time) there is one big mission:</p>

<blockquote>
<p>Make government a sustainable part of the UK tech community</p>
</blockquote>

<p>That means in 10 years time experienced tech people from across the
country, as well as people straight from university, choosing to work
for government. Not just for some abstract and personal reason (though
that&rsquo;s fine too), but because it&rsquo;s a a genuinely interesting place to
work. That one&rsquo;s on us.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/06/23/using-owasp-zap-from-the-command-line/">Using OWASP ZAP from the command line</a>
      </h1>
      <span class="post-date">Jun 23, 2014 &middot; 2 minute read
      </span>
      
      <p>I&rsquo;m a big fan of <a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">OWASP ZAP</a> or
the Zed Attack Proxy. It&rsquo;s suprisingly user friendly and nicely pulls of
it&rsquo;s aim of being useful to developers as well as more hardcore penetration testers.</p>

<p>One of the features I&rsquo;m particularly fond of is the aforementioned
proxy. Basically it can act as a transparent HTTP proxy, recording the
traffic, and then analyse that to conduct various active security tests;
looking for XSS issues or directory traversal vulnerabilities for
instance. The simplest way of seeding the ZAP with something to analyse is using
the simple inbuilt spider.</p>

<p>So far, so good. Unfortunately ZAP isn&rsquo;t designed to be used from the
command line. It&rsquo;s either a thick client, or it&rsquo;s a proxy with a simple
API. Enter <a href="https://github.com/garethr/zapr">Zapr</a>.</p>

<p>Zapr is a pretty simple wrapper around the ZAP API (using the
<a href="https://github.com/vpereira/owasp_zap">owasp_zap</a> library under the
hood). All it does is:</p>

<ul>
<li>Launch the proxy in headless mode</li>
<li>Trigger the spider</li>
<li>Launch various attacks against the collected URLs</li>
<li>Print out the results</li>
</ul>

<p>This is fairly limited, in that a spider isn&rsquo;t going to work
particularly well for a mor interactive application, but it&rsquo;s a farily good
starting point. I may add different seed methods in the future (or would
happily accept pull requests). Usage wise it&rsquo;s as simple as:</p>

<pre><code>zapr --summary http://localhost:3000/
</code></pre>

<p>That will print you out something like the following, assuming it finds
an issue.</p>

<pre><code>+-----------------------------------+----------+----------------------------------------+
| Alert                             | Risk     | URL                                    |
+-----------------------------------+----------+----------------------------------------+
| Cross Site Scripting (Reflected)  | High     |http://localhost:3000/forgot_password   |
+-----------------------------------+----------+----------------------------------------+
</code></pre>

<p>The above alert is taken from a <a href="https://github.com/garethr/zapr-example">simple example</a>,
using the <a href="https://github.com/OWASP/railsgoat">RailsGoat</a> vulnerable web
application as a scape goat. You can see the resulting output from
<a href="https://travis-ci.org/garethr/zapr-example">Travis running the tests</a>.</p>

<p>Zapr is a bit of a proof of concept so it&rsquo;s not particularly robust or
well tested. Depending on usage and interest I may tidy it up and extend
it, or I may leave it as a useful experiment and try and finally get ZAP
support into <a href="http://gauntlt.org">Gauntlt</a>, only time will tell.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/04/25/consul/">Consul, DNS and Dnsmasq</a>
      </h1>
      <span class="post-date">Apr 25, 2014 &middot; 2 minute read
      </span>
      
      

<p>While at <a href="http://craft-conf.com/2014">Craft</a> I decided to have a quick look at
<a href="http://www.consul.io/">Consul</a>, a new service discovery framework with
a few intersting features. One of the main selling points is a DNS
interface with a nice API. The <a href="http://www.consul.io/intro/index.html">Introduction</a>
shows how to use this via the dig command line tool, but how do you use
a custom internal DNS server without modifying all your applications?
One answer to this question is
<a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">Dnsmasq</a>.</p>

<p>I&rsquo;m not explaining Consul here, the above mentioned introduction does a
good job of stepping through the setup. The following assumes you have
installed and started consul.</p>

<h2 id="installation-and-configuration">Installation and configuration</h2>

<p>I&rsquo;m running these examples on an Ubuntu 14.04 machine, but dnsmasq
should be available and packaged for lots of different operating
systems.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>apt-get install dnsmasq
</pre></div>

<p>Once installed we can create a very simple configuration.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #003388">echo</span> <span style="color: #dd2200; background-color: #fff0f0">&quot;server=/consul/127.0.0.1#8600&quot;</span> &gt; /etc/dnsmasq.d/10-consul
</pre></div>

<p>All we&rsquo;re doing here is specifying that DNS requests for consul services
are to be dealt with by the DNS server at 127.0.0.1 on port 8600. Unless
you&rsquo;ve changed the consul defaults this should work.</p>

<p>Just in case you prefer Puppet their is already a handy
<a href="https://github.com/saz/puppet-dnsmasq">dnsmasq</a> module. The resulting
puppet code then looks like this.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #008800; font-weight: bold">include</span> <span style="color: #336699">dnsmasq</span>
<span style="color: #336699">dnsmasq</span>::<span style="color: #336699">conf</span> { <span style="color: #dd2200; background-color: #fff0f0">&#39;consul&#39;</span>:
  <span style="color: #336699">ensure</span>  =&gt; <span style="color: #008800; font-weight: bold">present</span>,
  <span style="color: #336699">content</span> =&gt; <span style="color: #dd2200; background-color: #fff0f0">&#39;server=/consul/127.0.0.1#8600&#39;</span>,
}
</pre></div>

<h2 id="usage">Usage</h2>

<p>The examples from the main documentation specify a custom DNS server for
dig like so:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>dig @127.0.0.1 -p <span style="color: #0000DD; font-weight: bold">8600</span> web.service.consul
</pre></div>

<p>With Dnsmasq installed and configured as above you should just be able
to do the following:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>dig web.service.consul
</pre></div>

<p>And now any of your existing applications will be able to use your
consul instance for service discovery via DNS.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/03/15/testing-vagrant-runs-with-cucumber/">Testing Vagrant runs with Cucumber</a>
      </h1>
      <span class="post-date">Mar 15, 2014 &middot; 2 minute read
      </span>
      
      <p>I&rsquo;ve been a big fan of <a href="http://www.vagrantup.com/">Vagrant</a> since it&rsquo;s
initial release and still find myself using it for various tasks.</p>

<p>Recently I&rsquo;ve been using it to test collections of Puppet modules. For a
single host
<a href="https://github.com/jvoorhis/vagrant-serverspec">vagrant-serverspec</a> is
excellent. Simply install the plugin, add a provisioner and write your
<a href="http://serverspec.org/">serverspec</a> tests. The serverspec provisioner
looks like the following:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>config.vm.provision <span style="color: #aa6600; background-color: #fff0f0">:serverspec</span> <span style="color: #008800; font-weight: bold">do</span> |spec|
  spec.pattern = <span style="color: #dd2200; background-color: #fff0f0">&#39;*_spec.rb&#39;</span>
<span style="color: #008800; font-weight: bold">end</span>
</pre></div>

<p>But I also found myself wanting to test behaviour from the host
(serverspec tests are run on the guest), and also wanted to write tests
that checked the behaviour of a multi-box setup. I started by simply
writing some <a href="http://cukes.info/">Cucumber</a> tests which I ran locally,
but I decided I wanted this integrated with vagrant. Enter
<a href="https://github.com/garethr/vagrant-cucumber-host">vagrant-cucumber-host</a>.
This implements a new vagrant provisioner which runs a set of cucumber
features locally.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>config.vm.provision <span style="color: #aa6600; background-color: #fff0f0">:cucumber</span> <span style="color: #008800; font-weight: bold">do</span> |cucumber|
  cucumber.features = []
<span style="color: #008800; font-weight: bold">end</span>
</pre></div>

<p>Just drop your features in the features folder and run <code>vagrant
provision</code>. If you just want to run the cucumber features, without any
of the other provisioners running you can use:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>vagrant provision --provision-with cucumber
</pre></div>

<p>Another advantage of writing this as a vagrant plugin is that it uses
the Ruby bundled with vagrant, meaning you just install the plugin
rather than faff about with a local Ruby install.</p>

<p>A couple of other vagrant plugins that I&rsquo;ve used to make the testing
setup easier are <a href="https://github.com/cogitatio/vagrant-hostsupdater">vagrant-hostsupdater</a>
and <a href="https://github.com/adrienthebo/vagrant-hosts">vagrant-hosts</a>. Both
help with managing hosts files, which makes writing tests without
knowing the IP addresses easier.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/02/16/buy-vs-build-your-monitoring-system/">Buy vs Build your Monitoring System</a>
      </h1>
      <span class="post-date">Feb 16, 2014 &middot; 5 minute read
      </span>
      
      

<p>At the excellent <a href="http://www.theguardian.com/info/developer-blog/2014/feb/15/london-devops-meetup-held-at-the-guardian">London Devops meetup</a> last week I asked what was
apparently a controversial question:</p>

<blockquote>
<p>should you just use software as a service monitoring products rather than integrate lots of open source tools?</p>
</blockquote>

<p>This got a few people worked up and I promised a blog post.</p>

<p>Note that I wrote a post listing lots of <a href="http://www.morethanseven.net/2013/10/13/looking-into-monitoring-and-logging-tools/">open source monitoring tools</a>
not that long ago. And I&rsquo;ve been to both the
<a href="http://monitorama.com/">Monitorama</a> events about open source
monitoring. And have a bunch of <a href="http://forge.puppetlabs.com/garethr?q=monitoring">Puppet modules for open source monitoring tools</a>. I&rsquo;m
a fan of both open source and of open source monitoring. Please don&rsquo;t
read this as an attack on either, and particularly on the work of
awesome people working on  great open source monitoring products.</p>

<h2 id="some-assumptions">Some assumptions</h2>

<ol>
<li>No one product exists that does everything. I think this is true for
SaaS as much as for open source.</li>
<li>Lets work with about 200 hosts. This is a somewhat arbitrary number I
know, some people will have more and others less.</li>
<li>If it saves money we&rsquo;ll pay yearly, rather than monthly or hourly.</li>
<li>We could probably get some volume discounts from some of the
suppliers, but we&rsquo;ll use list prices for this post.</li>
</ol>

<h2 id="show-me-the-money">Show me the money</h2>

<p>So what would it cost to get up and running with a state of the art
software as a service monitoring system? In order to do this we need to
choose our software. For this post that means I&rsquo;m going to pick products
I&rsquo;ve used (sometimes only a bit) and like. This isn&rsquo;t a comprehensive
study of all the alternatives I&rsquo;m afraid - though feel free to write
your own alternative blog posts.</p>

<ul>
<li><p><a href="http://newrelic.com/">New Relic</a> provides a crazy amount of data about
the running of both your servers and your applications. This includes
application performance data, errors, low level metrics and even rolled
up method or database query performance. $149 per host per month for our
200 hosts gives us <em>$29,800</em> per month.</p></li>

<li><p><a href="https://metrics.librato.com">Librato Metrics</a> provides a fantastic way
of storing arbitrary time series data. We&rsquo;re already storing lots of
data in New Relic but Metrics provides us with less opinionated software
so we can use it for anything, for instance number of logins or searches
or other business level metrics. We&rsquo;ll go for a plan with 200 data sources, 100 metrics each and at 10 second resolution for a cost of <em>$3,860</em> per month.</p></li>

<li><p><a href="http://www.pagerduty.com/">Pagerduty</a> is all about the alerts side of
monitoring. Most of the other SaaS tools we&rsquo;ve chosen integrate with it
so we can make sure we get actionable emails and SMS messages to the
right people at the right time. Our plan costs $18 per person per month,
so lets say we have 30 people at a cost of <em>$540</em> per month.</p></li>

<li><p><a href="https://papertrailapp.com/">Papertrail</a> is all about logs. Simple setup
your servers with syslog and Papertrail will collect, analyze and store
all your log messages. You get a browser based interface, search tools
and the ability to setup alerts. We like lots of logs so we&rsquo;ll have a
plan for 2 weeks of search, 1 year archive and 100GB month of log
traffic. That all costs <em>$575</em> per month.</p></li>

<li><p><a href="https://www.getsentry.com">Sentry</a> is all about exceptions. We could be
simply logging these and sending them to Papertrail but Sentry provides
tools for tracking and rolling up occurences. We&rsquo;ll go for a plan with
90 days of history and 200 events per minute at a cost of <em>$199</em> a
month.</p></li>

<li><p><a href="https://www.pingdom.com">Pingdom</a> used to provide a very simple
external check service, but now they have added more complex multistage
checks as well as real user monitoring to the basic ping. We&rsquo;ll choose
the plan with 250 checks, 20 Real User Monitoring sites and 500 SMS
alerts for <em>$107 a month</em>.</p></li>
</ul>

<h2 id="how-much">How much!</h2>

<p>In total that all comes to <em>$35,080 (£20,922)</em> per month, or
<em>$420,960 (£251,062)</em> per year.</p>

<p>Now the first reaction of lots of people will be <em>that&rsquo;s a lot of money</em>
and it is. But remember open source isn&rsquo;t free either. We need to pay
for:</p>

<ul>
<li>The servers we run our monitoring software on</li>
<li>The people to operate those servers</li>
<li>The people to install and configure our monitoring software</li>
<li>The office space and other costs of employing people (like management
and hiring)</li>
</ul>

<p>I think people with the ability to build software tend to forget they
are expensive, whether as a contractor or as a full time member of
staff. And people without management experience tend to forget costs
like insurance, rent, management overhead, recruitment, etc.</p>

<p>And probably more important than these for some people we need to consider:</p>

<ul>
<li>The time taken to build a good open source monitoring system</li>
</ul>

<p>The time needed to put together a good monitoring stack based on for
instance logstash, kibana, riemann, sensu, graphite and collectd isn&rsquo;t
small. And don&rsquo;t forget the number of other moving parts like redis,
rabbitmq and elasticsearch that need installing configuring and
maintaining. That probably means compromising in the short term or
shipping later. In a small team how core is building your monitoring
stack to what you do as a business?</p>

<h2 id="but-i-can-t-use-saas">But I can&rsquo;t use SaaS</h2>

<p>For some people, using a software as a service product just isn&rsquo;t going
to cut it. Here&rsquo;s a list of reasons I can think of:</p>

<ul>
<li>Regulation constrains where your data can be stored, for instance it&rsquo;s
not allowed out of the country</li>
<li>Sheer size of infrastructure, although you may be able to get a volume
discount it might not be enough</li>
</ul>

<p>I think everything else is a cost/benefit issue or personal preference
(or bias). Happy to add more to that list, but I don&rsquo;t think it&rsquo;s a very
long list.</p>

<h2 id="conclusions">Conclusions</h2>

<p>I&rsquo;ve purposefully not talked about the quality of the tools here, just
the cost. I&rsquo;ve also not mentioned that it&rsquo;s likely not an all or nothing
decision, lots of people will mix SaaS products and open source tools.</p>

<p>Whether taking a SaaS approach will be quicker, cheaper or better will
depend on your specific business context. But try and make that about
the organisation and not about the technology.</p>

<p>If you&rsquo;ve never used the current crop of SaaS monitoring
tools (and not just the one&rsquo;s mentioned above) then I think you&rsquo;re missing
out. Even if you stick with a mainly open source monitoring stack you
might look at your tools a bit differently after you&rsquo;ve experimented
with some of the commercial competition.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2014/02/05/a-template-for-puppet-modules/">A template for Puppet modules</a>
      </h1>
      <span class="post-date">Feb 5, 2014 &middot; 3 minute read
      </span>
      
      

<p>A little while ago I published a <a href="https://github.com/garethr/puppet-module-skeleton">template writing your own puppet modules</a>. It&rsquo;s
very opinionated but comes out of the box with lots of the tools you
eventually find and add to your tool box. I&rsquo;m posting this as it came
up at the recent <a href="http://cfgmgmtcamp.eu">Configuration Management Camp</a>
and after discussing it I realised I hadn&rsquo;t actually wrote anything
about it anywhere.</p>

<h2 id="what-do-you-get">What do you get?</h2>

<ul>
<li>A simple install, config, service class pattern</li>
<li>Unit tests with <a href="https://github.com/rodjek/rspec-puppet">rspec-puppet</a></li>
<li>Rake tasks for <a href="https://github.com/rodjek/puppet-lint">linting</a> and <a href="https://github.com/gds-operations/puppet-syntax">syntax checking</a></li>
<li>Integration tests using <a href="https://github.com/puppetlabs/beaker">Beaker</a></li>
<li>A Modulefile to provide Forge metadata</li>
<li>Command line tools to upload to the Forge with <a href="https://github.com/maestrodev/puppet-blacksmith">blacksmith</a></li>
<li>A README based on the Puppetlabs documentation standards</li>
<li><a href="https://travis-ci.org">Travis CI</a> configuration based on the official
Puppetlabs support matrix</li>
<li>A Guardfile which can run all the tests when you change manifests</li>
</ul>

<p>Obviously you can choose not to use parts of this, or even delete
aspects, but I find that approach much quicker than starting from scratch
or copying files from previous modules and changing names.</p>

<h2 id="how-can-i-use-it">How can I use it?</h2>

<p>Simple. The following will install the module skeleton to
<code>~/.puppet/var/puppet-module/skeleton</code>. This turns out to be picked up
by the Puppet module tool.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>git clone https://github.com/garethr/puppet-module-skeleton 
<span style="color: #003388">cd</span> puppet-module-skeleton
find skeleton -type f | git checkout-index --stdin --force --prefix=<span style="color: #dd2200; background-color: #fff0f0">&quot;</span><span style="color: #336699">$HOME</span><span style="color: #dd2200; background-color: #fff0f0">/.puppet/var/puppet-module/&quot;</span> --
</pre></div>

<p>With that in place you can then just run the following to create a new
module, where puppet-ntp is the name of our new module.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>puppet module generate puppet-ntp
</pre></div>

<p>We use <code>puppet module</code> like this rather than just copying the files
because otherwise you would have to rename everything from class names
to test assertions. The skeleton actually contains erb templates in
places, and running <code>puppet module generate</code> results in the module name
being available to those templates.</p>

<h2 id="now-what">Now what?</h2>

<p>Assuming you have run the above commands you should have a folder called
<code>puppet-ntp</code> in your current directory. <code>cd</code> into that and then install
the dependencies:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>bundle install
</pre></div>

<p><a href="http://bundler.io/">Bundler </a>is a dependency manager for Ruby. If you
don&rsquo;t already have it installed you should be able to do so with the
following:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>gem install bundler
</pre></div>

<p>Now you have the dependencies why not run the full test suite? This
checks syntax, lints the Puppet code and runs the unit tests.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>bundle <span style="color: #003388">exec</span> rake <span style="color: #003388">test</span>
</pre></div>

<p>Unit tests give fast feedback and help make sure the code you write is
going to do what you intend, but they aren&rsquo;t actually applying the
manifests to a real machine. For that you want an integration test.
You&rsquo;ll need <a href="http://vagrantup.com">Vagrant</a> installed for this next
step. Lets run those as well with:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>bundle <span style="color: #003388">exec</span> rspec spec/acceptance
</pre></div>

<p>This will take a while, especially the first time. This uses Beaker to
download a virtual machine from Puppetlabs (if you don&rsquo;t already have
it) and then brings up a new machine, applies a simple manifest, runs
the acceptance tests and then destroys the machine.</p>

<p>The <code>CONTRIBUTING.md</code> file has more information for running the test
suite.</p>

<h2 id="what-s-new">What&rsquo;s new?</h2>

<p>I&rsquo;ve recently added a <a href="https://github.com/guard/guard">Guardfile</a> to
help with testing. You can run this with:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>bundle <span style="color: #003388">exec</span> guard
</pre></div>

<p>Now in a separate tab or pane make a change to any of the manifests. The
tests should run automatically in the tab or pane where guard is
running.</p>

<h2 id="can-you-add-this-new-tool">Can you add this new tool?</h2>

<p>Probably. Although I started the repo a few other people have
contributed code or made improvements already. Just sent a pull request
or open an issue.</p>

      
    </div>
    
    

<ul class="pagination">
    
    <li>
        <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li
    >
    <a href="/page/2/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/">1</a></li>
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/page/2/">2</a></li>
    
    
    
    
    
     
        
        
    
    
    <li
    class="active"><a href="/page/3/">3</a></li>
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/page/4/">4</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/page/43/">43</a></li>
    
    
    <li
    >
    <a href="/page/4/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li>
        <a href="/page/43/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>

  </div>
</div>



</body>
</html>

