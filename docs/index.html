<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.51" />
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>More than seven &middot; More than seven</title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  
  
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="More than seven &middot; More than seven" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-435455-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-08">
<div class="sidebar">
  <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYIKK3M&placement=morethansevennet" id="_carbonads_js"></script>
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1><a href="/">More than seven</a></h1>
      <p class="lead">Writing about code. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2018/12/15/what-is-cnab/">What is CNAB?</a>
      </h1>
      <span class="post-date">Dec 15, 2018 &middot; 6 minute read
      </span>
      
      

<p>We announced <a href="https://cnab.io">Cloud Native Application Bundles (CNAB)</a> at DockerCon EU and Microsoft Connect just last week, and I spent a bunch of time talking to folks and anwsering questions about it at KubeCon too. As I’m heading home I thought it would be good to write down a few thoughts about what CNAB <em>is</em>. As I see it CNAB is two things:</p>

<ul>
<li>Formalisation of a pattern we’ve seen for multi-toolchain installers</li>
<li>Commoditization of the packaging part of the infrastructure-as-code stack</li>
</ul>

<p>Let’s take each of these in turn.</p>

<h2 id="formalisation-of-a-pattern-we-ve-seen-for-multi-toolchain-installers">Formalisation of a pattern we’ve seen for multi-toolchain installers</h2>

<p>The explosion of APIs for infrastructure services has led to a corresponding explosion of tools to help you manage and orchestrate them. From API clients for individual projects (countless Kubernetes configuration management tools) to cloud-provider specific tools (CloudFormation templates, ARM templates) to high-level DSLs (Ansible, Terraform). Throw in the <a href="http://mikehadlow.blogspot.com/2012/05/configuration-complexity-clock.html">configuration complexity clock</a> (so we have Pulumi in Typescript, Terraform with it’s own HCL DSL, too much YAML everywhere) and we have a lot of tool options. I posit this choice is a good thing, and that we’re never going to see everyone agree on one approach or another. One pattern that has emerged is packaging API clients as Docker images. <a href="https://hub.docker.com/r/lachlanevenson/k8s-kubectl">lachlanevenson/k8s-kubectl</a> has seen 5 million pulls, there are CloudFormation images on Hub that have millions of pulls, the official Terraform image has more than 10 million pulls. There are also lots of projects like <a href="https://github.com/jtbonhomme/terraform-ansible-docker">terraform-ansible-docker</a> which use multiple tools at the same time. CNAB is a formalisation of these patterns.</p>

<h2 id="commoditization-of-the-packaging-part-of-the-infrastructure-as-code-stack">Commoditization of the packaging part of the infrastructure-as-code stack</h2>

<p>There is a now familiar pattern when it comes to infrastructure-as-code tools, namely the introduction of a package format and some form of registry. Puppet and the Forge. Chef and the Supermarket. Ansible and Ansible Galaxy. Terraform and the Module Registry. Everyone basically creates a tar file with some metadata. Not all projects have done this, but most would probably benefit from doing so. Compose files, ARM templates, CloudFormation templates; all are shared predominantly as source artefacts which are copy-and-pasted around.</p>

<p>CNAB aims to commoditize this part of the stack and provide tools for anyone implementing something similar. It’s predominantly undifferentiated heavy lifting. No-one is competing based on the package metadata format so maybe lets build some agreement, some shared tooling and move on.</p>

<h2 id="what-has-this-got-to-do-with-kubernetes">What has this got to do with Kubernetes?</h2>

<p>One point that came up in a few conversations around CNAB was what this has to do with Kubernetes? Typically this came from people so deep into Kubernetes that all they can see is the Kubernetes API. If that’s you then you probably don’t need CNAB, especially at this early stage. You probably think in one of two ways when it comes to application of configuration:</p>

<ul>
<li>You like the package metaphor and you’re a big fan of Helm</li>
<li>You don’t like the package metaphor and you use some other tool to access the Kubernetes API more directly</li>
</ul>

<p>Back to our two original points. When it comes to a multi-toolchain installer, in the case of Kubernetes-only, you might not have multiple toolchains so this point is moot. Everything in your world is just the Kubernetes API.</p>

<p>When it comes to the second point around a standard for packaging, Helm already serves this need within the tight scope of Kubernetes. I fully expect to see (or hey, to build) a Helm plugin which will allow for wrapping a Helm chart in CNAB. There are a few advantages to CNAB support for Helm; a single artefact could include the desired Helm chart and it’s dependent charts and it could include all of the images in use within those charts. That single artefact can be signed and stored in a registry of your choise. But that’s mainly a case of incremental benefit to most Helm users. It’s also theorectical, CNAB is just a specifcation, so concrete things like a Helm plugin still need to be actually built.</p>

<p>What I would say to those that view everything through a Kubernetes lens is that not everyone does. CNAB is mainly for a messier world of multiple toolchains and multiple APIs.</p>

<h2 id="why-you-might-care">Why you might care?</h2>

<p>Depending on your role in the pantheon of software development you may care about one or both of the original points. You may care about them directly (especially if you’re a software vendor) or indirectly (because of what they allow us to collectively build for end-users.)</p>

<p>The story is pretty straightforward if you’re a software vendor. It’s very likely you’re shipping software to customers using multiple toolchains. Either you’re dealing with the complexity of asking customers to install particular tools and providing content for each (say asking users to first run some Terraform code and then run something else) or you’re struggling to get a large number of different teams to use the same tool and cram everything into it. Lots of vendors also have something that looks like a storefront for mixed content, or multiple stores for individual tools. Everyone is getting bored of supporting all the different formats, so a standard here appeals.</p>

<p>From the end user point of view the story is more about future potential. This is analogous to other standards. You might not have read or implemented anything against the OCI image or distribution spec, but you benefit from the compatability between all the different registries and runtimes. If you’ve built a multi-toolchain installer then you at least appreciate one of the problems CNAB aims to solve. But then you already have a point solution and the CNAB tooling is early here. You only benefit from commoditization of the format indirectly, and only if it’s actually adopted by multiple tools. But assuming it is widely adopted, in the future when a nifty new infrastructure as code tool comes along (say like Pulumi recently, or Terraform previously) then you’ll aleady know how to install applications defined using it if it implements the CNAB specifcation. You’ll already have CI/CD toolchains that accomodate CNAB. You’ll already have CNAB-compatible tools for storing and distributing bundles. The typical barriers to entry for yet another tool are reduced.</p>

<h2 id="the-importance-of-agreement">The importance of agreement</h2>

<p>There is a risk with any effort like this, one that aims to solve a general problem at a low level, that the actual user need gets lost. This is one of those solutions which impacts tool builders directly, and end users somewhat indirectly. That means you have to be a certain type of developer to benefit from looking at CNAB today. But if you look at <a href="https://blog.docker.com/2018/12/docker-app-and-cnab/">Docker App</a> you’ll find a much more opinionated tool which just happens to implement CNAB under the hood, without exposing it to end users. The end user benefits there (sharing Compose-based applications on Docker Hub, a single artefact with the application definition and associated images) are much more concrete.</p>

<p>CNAB isn’t about one tool to rule them alI. It’s about building agreement between people and projects solving the same set of problems. That agreement means more time to focus on end users problems rather than undifferentiated heavy lifting and more compatibility between tools. I expect the future to look like a range of completely separate tools for specific formats and toolchains which just happen to be compatible because they implement CNAB. We can then build a whole new set of tools that work across all of these packages, from graphical installers to documentation generation to whatever else we can think of. If that sounds interesting join the conversation around this <a href="https://github.com/deislabs/cnab-spec">new specifaction</a> and lets see if it just might work.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2018/07/29/knative-build-with-docker-buildkit-img/">Knative Build with Docker, BuildKit and Img</a>
      </h1>
      <span class="post-date">Jul 29, 2018 &middot; 4 minute read
      </span>
      
      

<p><a href="https://github.com/knative/build">Knative Build</a> is one of the components of <a href="https://cloud.google.com/knative/">Knative</a> that shipped last week.
Knative is described as a set of <em>&ldquo;essential base primitives&rdquo;</em>, one of those is an approach to describing build pipelines to run on Kubernetes.</p>

<p><a href="https://github.com/knative/docs/blob/master/build/installing-build-component.md">Installing</a> <code>knative/build</code> is relatively simple as long as you have
a Kubernetes cluster running at least 1.10. Handily Docker Desktop for <a href="https://store.docker.com/editions/community/docker-ce-desktop-windows">Windows</a> or
<a href="https://store.docker.com/editions/community/docker-ce-desktop-mac">Mac</a> makes it easy to get a local cluster up and running.</p>

<pre><code>kubectl apply -f https://storage.googleapis.com/knative-releases/build/latest/release.yaml
</code></pre>

<p>With Knative Build installed we can describe our build pipelines using the new <code>Build</code> and <code>BuildTemplate</code> objects.
The <a href="https://github.com/knative/docs/blob/master/build/builds.md#examples">documentation</a> covers a few basic examples and
the <a href="https://github.com/knative/build/tree/master/test">tests folder</a> has more. The project is early, so browsing through these
has been the best way I&rsquo;ve found of discovering how to do various things. In this post I thought I&rsquo;d try a few examples, making use
of the latest build functionality in Docker 18.06 and using BuildKit via <a href="https://github.com/genuinetools/img">Img</a>.</p>

<h2 id="knative-build-and-docker-build">Knative Build and Docker Build</h2>

<p>First lets describe a <code>BuildTemplate</code> for BuildKit. Templates can be reused for different builds by defining parameters that need to be set by the <code>Build</code>.
Templates aren&rsquo;t strictly required (see the basic examples mentioned above) but feel like a useful tool in most cases. The following template uses
the latest version of the Docker client image. We enable the experimental BuildKit builder, which isn&rsquo;t stricktly required but has some nifty new features.
We also bind this to the local Docker socket, so you need to be running Docker 18.06 on the server too. Again, if you&rsquo;re using Docker Desktop locally then you&rsquo;re all set.
Save the following as <code>buildkit.yaml</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>build.knative.dev/v1alpha1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>BuildTemplate<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>buildkit<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>parameters:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>IMAGE<span style="color:#bbb">
</span><span style="color:#bbb">    </span>description:<span style="color:#bbb"> </span>Where<span style="color:#bbb"> </span>to<span style="color:#bbb"> </span>publish<span style="color:#bbb"> </span>the<span style="color:#bbb"> </span>resulting<span style="color:#bbb"> </span>image.<span style="color:#bbb">
</span><span style="color:#bbb">  </span>steps:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>build<span style="color:#bbb">
</span><span style="color:#bbb">    </span>image:<span style="color:#bbb"> </span>docker:<span style="color:#00d;font-weight:bold">18.06</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>env:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>DOCKER_BUILDKIT<span style="color:#bbb">
</span><span style="color:#bbb">      </span>value:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;1&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>args:<span style="color:#bbb"> </span>[<span style="color:#d20;background-color:#fff0f0">&#34;build&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;-t&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;${IMAGE}&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;.&#34;</span>]<span style="color:#bbb">
</span><span style="color:#bbb">    </span>volumeMounts:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>docker-socket<span style="color:#bbb">
</span><span style="color:#bbb">      </span>mountPath:<span style="color:#bbb"> </span>/var/run/docker.sock<span style="color:#bbb">
</span><span style="color:#bbb">  </span>volumes:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>docker-socket<span style="color:#bbb">
</span><span style="color:#bbb">    </span>hostPath:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>path:<span style="color:#bbb"> </span>/var/run/docker.sock<span style="color:#bbb">
</span><span style="color:#bbb">      </span>type:<span style="color:#bbb"> </span>Socket</code></pre></div>
<p>Let&rsquo;s add that template to the cluster:</p>

<pre><code>kubectl apply -f buildkit.yaml
</code></pre>

<p>Then we describe our build. For this I&rsquo;m using <a href="https://github.com/garethr/kubeval">kubeval</a> but you can use source repository which provides
a Dockerfile to build from. Save the following as <code>kubeval-buildkit.yaml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>build.knative.dev/v1alpha1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Build<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>kubeval-buildkit<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>source:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>git:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>url:<span style="color:#bbb"> </span>https://github.com/garethr/kubeval.git<span style="color:#bbb">
</span><span style="color:#bbb">      </span>revision:<span style="color:#bbb"> </span>master<span style="color:#bbb">
</span><span style="color:#bbb">  </span>template:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>name:<span style="color:#bbb"> </span>buildkit<span style="color:#bbb">
</span><span style="color:#bbb">    </span>arguments:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>IMAGE<span style="color:#bbb">
</span><span style="color:#bbb">      </span>value:<span style="color:#bbb"> </span>garethr/kubeval</code></pre></div>
<p>Finally trigger the build by submitting the <code>Build</code> object to the Kubernetes API.</p>

<pre><code>kubectl apply -f kubeval-buildkit.yaml
</code></pre>

<p>We can watch the build by watching the object:</p>

<pre><code>kubectl get build kubeval-buildkit -o yaml -w
</code></pre>

<p>For the actual build logs we need to go a little deeper. From the above output you&rsquo;ll see the name of the pod. Use that in the following command
(just swap out the <code>gztzq</code> part) to get the build logs from Docker:</p>

<pre><code>kubectl -n default logs -f kubeval-buildkit-gztzq -c build-step-build
</code></pre>

<h2 id="knative-build-and-img">Knative Build and Img</h2>

<p>The above example uses the hosts Docker daemon, but if you want to run the build without you&rsquo;re in luck. <a href="https://github.com/genuinetools/img">Img</a>
is a &ldquo;standalone, daemon-less, unprivileged Dockerfile and OCI compatible container image builder.&rdquo; It&rsquo;s using the same build engine, BuildKit, as
we used above with Docker 18.06. In this example we&rsquo;ll need to push the resulting image to a remote repository, as it won&rsquo;t show up in the local engine
when you run <code>docker images</code>. For that Knative Build provides some handy <a href="https://github.com/knative/docs/blob/master/build/auth.md">auth options</a>.
Let&rsquo;s create a <code>Secret</code> and an asscoiated <code>ServiceAccount</code>. The username and password want to be changed to your authentication credentials for Docker Hub.
Save this as <code>serviceaccount.yaml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Secret<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>docker-hub<span style="color:#bbb">
</span><span style="color:#bbb">  </span>annotations:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>build.knative.dev/docker-<span style="color:#00d;font-weight:bold">0</span>:<span style="color:#bbb"> </span>https://index.docker.io/v1/<span style="color:#bbb">
</span><span style="color:#bbb"></span>type:<span style="color:#bbb"> </span>kubernetes.io/basic-auth<span style="color:#bbb">
</span><span style="color:#bbb"></span>stringData:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>username:<span style="color:#bbb"> </span>&lt;your<span style="color:#bbb"> </span>username<span style="color:#d20;background-color:#fff0f0">&gt;
</span><span style="color:#d20;background-color:#fff0f0">  password: &lt;your password&gt;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>build-bot<span style="color:#bbb">
</span><span style="color:#bbb"></span>secrets:<span style="color:#bbb">
</span><span style="color:#bbb"></span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>docker-hub</code></pre></div>
<p>We then define a new <code>BuildTemplate</code> for Img. Note this one has two steps rather than just one. Save the following as <code>img.yaml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>build.knative.dev/v1alpha1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>BuildTemplate<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>img<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>parameters:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>IMAGE<span style="color:#bbb">
</span><span style="color:#bbb">    </span>description:<span style="color:#bbb"> </span>Where<span style="color:#bbb"> </span>to<span style="color:#bbb"> </span>publish<span style="color:#bbb"> </span>the<span style="color:#bbb"> </span>resulting<span style="color:#bbb"> </span>image.<span style="color:#bbb">
</span><span style="color:#bbb">  </span>steps:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>build<span style="color:#bbb">
</span><span style="color:#bbb">    </span>image:<span style="color:#bbb"> </span>garethr/img<span style="color:#bbb">
</span><span style="color:#bbb">    </span>args:<span style="color:#bbb"> </span>[<span style="color:#d20;background-color:#fff0f0">&#34;build&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;-t&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;${IMAGE}&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;.&#34;</span>]<span style="color:#bbb">
</span><span style="color:#bbb">    </span>securityContext:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>privileged:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>push<span style="color:#bbb">
</span><span style="color:#bbb">    </span>image:<span style="color:#bbb"> </span>garethr/img<span style="color:#bbb">
</span><span style="color:#bbb">    </span>args:<span style="color:#bbb"> </span>[<span style="color:#d20;background-color:#fff0f0">&#34;push&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;${IMAGE}&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">&#34;-d&#34;</span>]<span style="color:#bbb">
</span><span style="color:#bbb">    </span>securityContext:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>privileged:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span></code></pre></div>
<p>With those defined we can submit them to Kubernetes:</p>

<pre><code>kubectl apply -f serviceaccount.yaml -f img.yaml
</code></pre>

<p>Finally we describe out build. The only changes to the above are the addition of the <code>serviceAccountName</code> property (so the build will have access to the Docker Hub credentials)
and swapping the <code>buildkit</code> template out for the <code>img</code> one we just defined. If you want this to work for you then you&rsquo;ll need to swap out the image name to a repository
you have permissions to push to, rather than <code>garethr/kubeval</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>build.knative.dev/v1alpha1<span style="color:#bbb">
</span><span style="color:#bbb"> </span>kind:<span style="color:#bbb"> </span>Build<span style="color:#bbb">
</span><span style="color:#bbb"> </span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">   </span>name:<span style="color:#bbb"> </span>kubeval-img<span style="color:#bbb">
</span><span style="color:#bbb"> </span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">   </span>serviceAccountName:<span style="color:#bbb"> </span>build-bot<span style="color:#bbb">
</span><span style="color:#bbb">   </span>source:<span style="color:#bbb">
</span><span style="color:#bbb">     </span>git:<span style="color:#bbb">
</span><span style="color:#bbb">       </span>url:<span style="color:#bbb"> </span>https://github.com/garethr/kubeval.git<span style="color:#bbb">
</span><span style="color:#bbb">       </span>revision:<span style="color:#bbb"> </span>master<span style="color:#bbb">
</span><span style="color:#bbb">   </span>template:<span style="color:#bbb">
</span><span style="color:#bbb">     </span>name:<span style="color:#bbb"> </span>img<span style="color:#bbb">
</span><span style="color:#bbb">     </span>arguments:<span style="color:#bbb">
</span><span style="color:#bbb">     </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>IMAGE<span style="color:#bbb">
</span><span style="color:#bbb">       </span>value:<span style="color:#bbb"> </span>garethr/kubeval</code></pre></div>
<p>Save the above as <code>kubeval-img.yaml</code> and finally submit the build:</p>

<pre><code>kubectl apply -f kubeval-img.yaml
</code></pre>

<p>As before we can watch the build by watching the relevant object:</p>

<pre><code>kubectl get build kubeval-img -o yaml -w
</code></pre>

<p>And again to get at the logs we&rsquo;ll rhe name of the pod. Use that in the following command
(just swap out the <code>gztzq</code> part) to get the build logs from Img:</p>

<pre><code>kubectl -n default logs -f kubeval-img-gztzq -c build-step-build
</code></pre>

<p>There are a few things to note with the above:</p>

<ul>
<li>The <code>img</code> images run as priviledged. I tried and failed to set the relevant capabilities instead but I&rsquo;m sure that&rsquo;s fixable
with a little more debugging</li>
<li>I rebuilt the <code>img</code> Docker image and pushed this to my repo. This image runs as root, due to a conflict with permissions and
the user in the original image. Again, I&rsquo;m sure that&rsquo;s also resolvable with a bit more spelunking.</li>
</ul>

<h2 id="conclusions">Conclusions</h2>

<p>The above demonstrates how to use Knative Build from what I&rsquo;ve been able to pick up from the documentation and examples. This definitely
feels like a component for folks to build higher-level interfaces on. It solves some useful problems but requires a fair understanding
of Kubernetes objects to utilise and interact with today. I could certainly see the potential however for some more user-fiendly tools on top of
this in the future.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/06/26/predictions-for-the-direction-of-serverless-platforms/">Predictions for the direction of serverless platforms</a>
      </h1>
      <span class="post-date">Jul 7, 2017 &middot; 5 minute read
      </span>
      
      

<p>While at <a href="http://www.jeffconf.com">JeffConf</a> I had a particularly
interesting conversation with <a href="https://twitter.com/anne_e_currie">Anne</a>,
<a href="https://twitter.com/monkchips">James</a> and
<a href="https://twitter.com/guypod">Guy</a>. Inspired by that, and
the fact James is currently writing a blog post a day, I thought I&rsquo;d
have a go at writing up some of my thoughts.</p>

<p>I want to focus on a couple of things relevant to the evolution of
Serverless as a platform and the resulting commercial ecosystem,
namely the importance of <a href="https://openservicebrokerapi.org/">Open Service Broker</a>
and a bet on <a href="https://openwhisk.incubator.apache.org/">OpenWhisk</a>.</p>

<p><img src="/public/predictions.png" alt="" /></p>

<p>The above is a pretty high-level picture of how I think Serverless
platforms are playing out. I&rsquo;ve skipped a few things from the diagram
that I&rsquo;ll come back to, and I&rsquo;m not trying to detail all options, just
the majority by usage, but the main points are probably:</p>

<h2 id="openwhisk">OpenWhisk</h2>

<p>OpenWhisk is one of a number of run-your-own-serverless platforms <a href="http://redmonk.com/fryan/2017/03/02/serverless-redefining-devops/">vying
for
attention</a>.
My guess is it&rsquo;s the one that will see actual market adoption over time.</p>

<p>One of the reasons for that is that <a href="https://developers.redhat.com/blog/2017/06/07/red-hat-and-apache-openwhisk/">Red Hat recently announced they are supporting
OpenWhisk</a>.
Specifically they are working to run OpenWhisk on top of Kubernetes
which I see as being something that will tap into the growing number of
people and companies adopting Kubernetes in one form or another.
Kubernetes provides a powerful platform to build higher-level user
interfaces on, and I see it ending up as the default here.</p>

<p>There are a few things that could make this prediction much messier. One
of those is that OpenWhisk is currently in the incubator for the Apache
Foundation. CNCF has been building up a product portfolio across tools
in this space, and has a <a href="https://github.com/cncf/wg-serverless">Serverless working
group</a>. It would be a shame if
this somehow ends up with a perceived need to <em>bless</em> something else.
The other might be say an aquisition of Serverless Framework by Docker
Inc, or a new entrant completely.</p>

<h2 id="open-service-broker">Open Service Broker</h2>

<p>Without supporting services to bind to, Serverless computing doesn&rsquo;t look as
interesting. Although you&rsquo;ll see some standalone Lambda usage it&rsquo;s much
more common to see it combined with API Gateway, DynamoDB, S3, Kinesis,
etc. The catch is that these are AWS services. Azure (with Azure
Functions) and Google Cloud (with Cloud Functions) are busy building
similar ecosystems. This makes the barrier to entry for a pure
technology play (like OpenWhisk or something else) incredibly high.</p>

<p>AWS Services work together because they are built by the same
organisation, and integrated together via the shared AWS fabric. How can
you build that sort of level of agreement between a large number of
totally unconnected third parties? What about exposing internal services
(for instance your large Oracle on-premise cluster) to your serverless
functions? Enter Open Service Broker.</p>

<p>Open Service Broker has <a href="https://www.cloudfoundry.org/open-service-broker-api-launches-as-industry-standard/">been around since the end of last
year</a>.
It defines an API for provisioning, deprovisioning and binding services
for use by other platforms, for instance by Cloud Foundry or Kubernetes or
similar. Here&rsquo;s a quick <a href="https://github.com/cloudfoundry-samples/github-service-broker-ruby">example
broker</a>.
I think we&rsquo;ll see Open Service Broker powering some powerful
higher-level user interfaces in other platforms eventually which aim to
compete directly with, for instance, the ease of binding an API Gateway
to a Lambda function in AWS. Especially if you&rsquo;re a service provider I&rsquo;d
get a march on the competition and start looking at this now. This is
also a potential avenue for the other cloud providers to expand on there
claims of openness. I&rsquo;d wager on us seeing Azure services available over
Open Service Broker for instance.</p>

<h2 id="a-few-extra-observations">A few extra observations</h2>

<ul>
<li>Anyone but Amazon will be real - on both the buyer side (a little) and
the vendor side (a lot) you&rsquo;ll see a number of unlikely
collaborations between competitors at the technology level.</li>
<li>Open Source is a fundamental part of any AWS competition. AWS hired
some great open source community focused people recently so expect to
see them try to head that threat off if it gets serious</li>
<li>The fact Amazon provides the entire stack AND runs a chunk of the
infrastructure for the other options help explains why people (again
especially other vendors) fear AWS.</li>
<li>Both Pivotal and Red Hat will be in the mix when it comes to hosted
serverless platforms, with CloudFoundry and OpenShift (powered by
OpenWhisk) respectively.</li>
<li>The stack in the middle of some OS, some provisioning, Kubernetes and
OpenWhisk will have lots of variants, including from a range of
vendors. Eventually some might focus on serverless, but for others
it will be simply another user interface atop a lower-level
infrastructure play.</li>
<li>If you&rsquo;re thinking &ldquo;But Cloud Foundry isn&rsquo;t serverless?&rdquo; then you&rsquo;re
not paying attention to things like the recent release of <a href="https://spring.io/blog/2017/07/05/introducing-spring-cloud-function">Spring Functions</a>.</li>
<li>In theory Azure and Google Cloud could end up playing in the same place
as AWS. But with the lead AWS Lambda has in the community that is going
to take something more than just building a parallel ecosystem. I could
totally see Azure embracing OpenWhisk as an option in Azure Functions,
in the way Azure Container Service is happy to provide multiple
options.</li>
</ul>

<p>Overall I&rsquo;ll be interested to see how this plays out, and whether my
guesses above turn out to be anywhere near right. There will be a lot of
intermediary state, with companies large and small, existing and new,
shipping software. And like anything else it will take time to stablise,
whether to something like the above or something else entirely.
I feel like the alternative to the above is simply near total domination
by 1 or maybe 2 of the main cloud providers, which would be less
interesting to guess about and made for a shorter blog post.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/06/26/schemas-for-kubernetes-types/">Schemas for Kubernetes types</a>
      </h1>
      <span class="post-date">Jun 26, 2017 &middot; 5 minute read
      </span>
      
      

<p>I&rsquo;ve been playing around building a few Kubernetes developer tools at
the moment and a few of those led me to the question; how do I validate
this Kubernetes resource definition? This simple question led me through
a bunch of GitHub issues without resolution, conversations with folks
who wanted something similar, the OpenAPI specification and finally to
what I hope is a nice resolution.</p>

<p>If you&rsquo;re just after the schemas and don&rsquo;t care for the details just
head on over to the following GitHub repositories.</p>

<ul>
<li><a href="https://github.com/garethr/kubernetes-json-schema">garethr/kubernetes-json-schema</a></li>
<li><a href="https://github.com/garethr/openshift-json-schema">garethr/openshift-json-schema</a></li>
</ul>

<p>OpenShift gets a separate repository as it has an independent version
scheme and adds a number of additional types into the mix.</p>

<h2 id="but-why">But why?</h2>

<p>It&rsquo;s worth asking the question <em>why</em> before delving too far into the
how. Let&rsquo;s go back to the problem; I have a bunch of Kubernetes resource
definitions, lets say in YAML, and I want to know if they are valid?</p>

<p>Now you might be thinking I could just run them with <code>kubectl</code>? This
raises a few issues which I don&rsquo;t care for in a developer tool:</p>

<ul>
<li>It requires <code>kubectl</code> to be installed and configured</li>
<li>It requires <code>kubectl</code> to be pointed at a working Kubernetes cluster</li>
</ul>

<p>Here are a few knock-on effects of the above issues:</p>

<ul>
<li>Running what should be a simple validate step in a CI system now
requires a Kubernetes cluster</li>
<li>Why do I have to shell out to something and parse it&rsquo;s output to validate
a document, for instance if I&rsquo;m doing it in the context of a unit test?</li>
<li>If I want to validate the definition against multiple versions of
Kubernetes I need multiple Kubernetes clusters</li>
</ul>

<p>Hopefully at this point it&rsquo;s clear why the above doesn&rsquo;t work. I don&rsquo;t
want to have to run a boat load of Kubernetes infrastructure to validate
the structure of a text file. Why can&rsquo;t I just have a schema in a
standard format with widespread library support?</p>

<h2 id="from-openapi-to-json-schema">From OpenAPI to JSON Schema</h2>

<p>Under-the-hood Kubernetes is all about types. Pods,
ReplicationControllers, Deployments, etc. It&rsquo;s these primatives that
give Kubernetes it&rsquo;s power and shape. These are described in the
Kubernetes source code and are used to generate an OpenAPI description of
the Kubernetes HTTP API. I&rsquo;ve been spelunking here before with some work on
<a href="https://github.com/garethr/garethr-kubernetes">generating Puppet types from this same specification</a>.</p>

<p>The latest version of OpenAPI in fact already contains the type
information we seek, encoded in a superset of <a href="http://json-schema.org">JSON
Schema</a> in the <code>definitions</code> key. This is
used by the various tools which generate clients from that definition.
For instance the official python client doesn&rsquo;t know about these types
directly, it all comes from the <a href="https://github.com/kubernetes-incubator/client-python/blob/master/scripts/update-client.sh">OpenAPI description of the
API</a>. But how
do we use those <code>definitions</code> separately for our own nefarious
validation purposes? Here&rsquo;s a quick sample of what we see in the <a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json">50,000
line-long OpenAPI definition file</a></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#a61717;background-color:#e3d2d2">-</span> <span style="color:#a61717;background-color:#e3d2d2">definitions:</span> {
    <span style="color:#a61717;background-color:#e3d2d2">io.k8s.api.admissionregistration.v1alpha1.AdmissionHookClientConfig:</span> <span style="color:#a61717;background-color:#e3d2d2">{</span>
      <span style="color:#a61717;background-color:#e3d2d2">description:</span> <span style="color:#b06;font-weight:bold">&#34;AdmissionHookClientConfig contains the information to make a TLS connection with the webhook&#34;</span>,
      <span style="color:#a61717;background-color:#e3d2d2">required:</span> <span style="color:#a61717;background-color:#e3d2d2">[</span>
        <span style="color:#b06;font-weight:bold">&#34;service&#34;</span>,
        <span style="color:#b06;font-weight:bold">&#34;caBundle&#34;</span>
      <span style="color:#a61717;background-color:#e3d2d2">]</span>,
      <span style="color:#a61717;background-color:#e3d2d2">properties:</span> <span style="color:#a61717;background-color:#e3d2d2">{</span>
        <span style="color:#a61717;background-color:#e3d2d2">caBundle:</span> <span style="color:#a61717;background-color:#e3d2d2">{</span>
          <span style="color:#a61717;background-color:#e3d2d2">description:</span> <span style="color:#b06;font-weight:bold">&#34;CABundle is a PEM encoded CA bundle which will be used to validate webhook&#39;s server certificate. Required&#34;</span>,
          <span style="color:#a61717;background-color:#e3d2d2">type:</span> <span style="color:#b06;font-weight:bold">&#34;string&#34;</span>,
          <span style="color:#a61717;background-color:#e3d2d2">format:</span> <span style="color:#b06;font-weight:bold">&#34;byte&#34;</span>
        }<span style="color:#a61717;background-color:#e3d2d2">,</span>
        <span style="color:#a61717;background-color:#e3d2d2">service:</span> {
          <span style="color:#a61717;background-color:#e3d2d2">description:</span> <span style="color:#b06;font-weight:bold">&#34;Service is a reference to the service for this webhook. If there is only one port open for the service, that port will be used. If there are multiple ports open, port 443 will be used if it is open, otherwise it is an error. Required&#34;</span>,
          <span style="color:#a61717;background-color:#e3d2d2">$ref:</span> <span style="color:#b06;font-weight:bold">&#34;#/definitions/io.k8s.api.admissionregistration.v1alpha1.ServiceReference&#34;</span>
        }
      <span style="color:#a61717;background-color:#e3d2d2">}</span>
    <span style="color:#a61717;background-color:#e3d2d2">},</span></code></pre></div>
<p>The discussion around wanting JSON Schemas for Kubernetes types has
cropped up in a few places before, there are some useful comments on <a href="https://github.com/kubernetes/kubernetes/issues/14987">this
issue</a> for
instance. I didn&rsquo;t find a comprehensive solution however, so set out on
a journey to build one.</p>

<h2 id="openapi2jsonschema">OpenAPI2JsonSchema</h2>

<p>The tooling I&rsquo;ve build for this purpose is called
<a href="https://github.com/garethr/openapi2jsonschema">openapi2jsonschema</a>.
It&rsquo;s not Kubernetes specific and should work with other OpenAPI
specificied APIs too, although as yet I&rsquo;ve done only a little testing of
that. Usage of <code>openapi2jsonschema</code> is fairly straightforward, just
point it at the URL for an OpenAPI definition and watch it generate a
whole bunch of files.</p>

<pre><code>openapi2jsonschema https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json
</code></pre>

<p><code>openapi2jsonschema</code> can generate different flavours of output, useful
for slightly different purposes. You probably only need to care about
this if you&rsquo;re generating you&rsquo;re own schemas or you want to work
completely offline.</p>

<ul>
<li>default - URL referenced based on the specified GitHub repository</li>
<li>standalone - de-referenced schemas, more useful as standalone documents</li>
<li>local - relative references, useful to avoid the network dependency</li>
</ul>

<p>The <a href="https://github.com/garethr/kubernetes-json-schema/blob/master/build.sh">build script</a>
for the Kubernetes schemas is a simple way of seeing this in practice.</p>

<h2 id="published-schemas">Published Schemas</h2>

<p>Using the above tooling I&rsquo;m publishing Schemas for Kubernetes, and for
OpenShift, which can be used directly from GitHub.</p>

<ul>
<li><a href="https://github.com/garethr/kubernetes-json-schema">garethr/kubernetes-json-schema</a></li>
<li><a href="https://github.com/garethr/openshift-json-schema">garethr/openshift-json-schema</a></li>
</ul>

<p>As an example of what these look like, here are the links to the latest <code>deployment</code> schemas for
1.6.1:</p>

<ul>
<li><a href="https://github.com/garethr/kubernetes-json-schema/tree/master/v1.6.1/deployment.json">v1.6.1/deployment.json</a></li>
<li><a href="https://github.com/garethr/kubernetes-json-schema/tree/master/v1.6.1-standalone/deployment.json">v1.6.1-standalone/deployment.json</a></li>
<li><a href="https://github.com/garethr/kubernetes-json-schema/tree/master/v1.6.1-local/deployment.json">v1.6.1-local/deployment.json</a></li>
</ul>

<h2 id="a-simple-example">A simple example</h2>

<p>There are lots of use cases for these schemas, although they are primarily
useful as a low-level part of other developer workflow tools. But at a most
basic level you can validate a Kubernetes config file.</p>

<p>Here is a quick example using the Python <a href="https://github.com/Julian/jsonschema">jsonschema
client</a> and an invalid deployment
file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ jsonschema -F <span style="color:#d20;background-color:#fff0f0">&#34;{error.message}&#34;</span> -i hello-nginx.json
<span style="color:#00d;font-weight:bold">1</span>.5.1-standalone/deployment.json
u<span style="color:#d20;background-color:#fff0f0">&#39;template&#39;</span> is a required property</code></pre></div>
<h2 id="what-to-do-with-all-those-schema">What to do with all those schema?</h2>

<p>As noted these schemas have lots of potential uses for development
tools. Here are a few ideas, some of which I&rsquo;ve already been hacking on:</p>

<ul>
<li>Demonstrating using with the more common YAML serialisation</li>
<li>Testing tools to show your Kubernetes configuration files are valid,
and against which versions of Kubernetes</li>
<li>Migration tools to check your config files are still valid against
master or beta releases</li>
<li>Integration with code editors, for instance via something like <a href="http://schemastore.org/json/">Schema
Store</a></li>
<li>Validation of Kubernetes configs generated by higher-level tools, like
Helm, Ksonnet or Puppet</li>
<li>Visual tools for crafting Kubernetes configurations</li>
<li>Tools to show changes between Kubernetes versions</li>
</ul>

<p>If you do use these schemas for anything please let me know, and I&rsquo;ll
try and keep them updated with releases of Kubernetes and OpenShift. I
plan on polishing the <code>openapi2jsonschema</code> tool when I get some time,
and I&rsquo;d love to know if anyone uses that with other OpenAPI compatible
APIs. And if all you want to do is validate your Kubernetes
configuration and don&rsquo;t care too much about what&rsquo;s happening under the
hood then stick around for the next blog post.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/05/29/replacing-cron-jobs-with-lambda-and-apex/">Replacing cron jobs with Lambda and Apex</a>
      </h1>
      <span class="post-date">May 29, 2017 &middot; 5 minute read
      </span>
      
      

<p>Everyone has little scripts that want running on some schedule. I&rsquo;ve
seen entire organisations basically running on cron jobs. But for all
the simplicity of cron it has a few issues:</p>

<ul>
<li>It&rsquo;s a per-host solution, in a world where hosts might be short-lived
or unavailable for some other reason</li>
<li>It requires a fully configured and secured machine to run on, which
comes with direct and indirect costs</li>
</ul>

<p>There are a variety of <em>distributed cron</em> solutions around, but each
adds complexity for what might be a throw-away script. In my view this
is the perfect usecase for trying out AWS Lambda, or other Serverless
platforms. With a Serverless platform the above two issues go away from
the point-of-view of the user, they are below the level of abstraction
of the provided service. Lets see a quick example of doing this.</p>

<h2 id="apex-and-lambda">Apex and Lambda</h2>

<p>There are a number of frameworks and tools for helping deploy Serverless
functions for different platforms. I&rsquo;m going to use <a href="http://apex.run/">Apex</a>
because I&rsquo;ve found it provides just enough of a user interface without
getting in the way of writing a function.</p>

<p>Apex supports a wide range of different languages, and has <a href="https://github.com/apex/apex/tree/master/_examples">lots of
examples</a> which
makes getting started relatively easy. Installation is
<a href="http://apex.run/#installation">straightforward</a> too.</p>

<h2 id="a-sample-function">A sample function</h2>

<p>The function isn&rsquo;t really relevant to this post, but I&rsquo;ll include one
for completeness. You can write functions in officially supported
languages (like Javascript or Python) or pick one of the languages
supported via a shim in Apex. I&rsquo;ve been writing Serverless functions in
Go and Clojure recently, but I prefer Clojure so lets use that for now.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#080;font-weight:bold">ns </span><span style="color:#369">net.morethanseven.hello</span>
    (<span style="color:#a60;background-color:#fff0f0">:gen-class</span> <span style="color:#a60;background-color:#fff0f0">:implements</span> [<span style="color:#369">com.amazonaws.services.lambda.runtime.RequestStreamHandler</span>])
    (<span style="color:#a60;background-color:#fff0f0">:require</span> [<span style="color:#369">clojure.java.io</span> <span style="color:#a60;background-color:#fff0f0">:as</span> <span style="color:#369">io</span>]
              [<span style="color:#369">clojure.string</span> <span style="color:#a60;background-color:#fff0f0">:as</span> <span style="color:#369">str</span>])
    (<span style="color:#a60;background-color:#fff0f0">:import</span> (<span style="color:#369">com.amazonaws.services.lambda.runtime</span> <span style="color:#369">Context</span>)))

(<span style="color:#080;font-weight:bold">defn </span><span style="color:#369">-handleRequest</span>
  [<span style="color:#369">this</span> <span style="color:#369">input-stream</span> <span style="color:#369">output-stream</span> <span style="color:#369">context</span>]
  (<span style="color:#080;font-weight:bold">let </span>[<span style="color:#369">handle</span> (<span style="color:#369">io/writer</span> <span style="color:#369">output-stream</span>)]
    (<span style="color:#369">.write</span> <span style="color:#369">handle</span> (<span style="color:#038">str </span><span style="color:#d20;background-color:#fff0f0">&#34;hello&#34;</span> <span style="color:#d20;background-color:#fff0f0">&#34;world&#34;</span>))
    (<span style="color:#369">.flush</span> <span style="color:#369">handle</span>)))</code></pre></div>
<p>This would be saved at
<code>functions/hello/src/net/morethanseven/hello.clj</code>, and the Apex
<code>project.json</code> file should point at the function above:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#b06;font-weight:bold">&#34;runtime&#34;</span>: <span style="color:#d20;background-color:#fff0f0">&#34;clojure&#34;</span>,
  <span style="color:#b06;font-weight:bold">&#34;handler&#34;</span>: <span style="color:#d20;background-color:#fff0f0">&#34;net.morethanseven.hello::handleRequest&#34;</span>
}</code></pre></div>
<p>You would also need a small configuration file at <code>functions/hello/project.clj</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#080;font-weight:bold">defproject </span><span style="color:#369">net.morethanseven</span> <span style="color:#d20;background-color:#fff0f0">&#34;0.1.0-SNAPSHOT&#34;</span>
  <span style="color:#a60;background-color:#fff0f0">:description</span> <span style="color:#d20;background-color:#fff0f0">&#34;Hello World.&#34;</span>
  <span style="color:#a60;background-color:#fff0f0">:dependencies</span> [[<span style="color:#369">com.amazonaws/aws-lambda-java-core</span> <span style="color:#d20;background-color:#fff0f0">&#34;1.1.0&#34;</span>]
                 [<span style="color:#369">com.amazonaws/aws-lambda-java-events</span> <span style="color:#d20;background-color:#fff0f0">&#34;1.1.0&#34;</span> <span style="color:#a60;background-color:#fff0f0">:exclusions</span> [
<span style="color:#369">com.amazonaws/aws-java-sdk-s3</span>
<span style="color:#369">com.amazonaws/aws-java-sdk-sns</span>
<span style="color:#369">com.amazonaws/aws-java-sdk-cognitoidentity</span>
<span style="color:#369">com.amazonaws/aws-java-sdk-kinesis</span>
<span style="color:#369">com.amazonaws/aws-java-sdk-dynamodb</span>]]
                 [<span style="color:#369">org.clojure/clojure</span> <span style="color:#d20;background-color:#fff0f0">&#34;1.8.0&#34;</span>]]
  <span style="color:#a60;background-color:#fff0f0">:aot</span> <span style="color:#a60;background-color:#fff0f0">:all</span>)</code></pre></div>
<p>The above is really just showing an example of how little code a
function might contain, the specifics are relevant only if you&rsquo;re
intersted in Clojure. But imagine the same sort of thing for your
language of choice.</p>

<h1 id="infrastructure">Infrastructure</h1>

<p>The interesting part (hopefully) of this blog post is the observation
that using AWS Lambda doesn&rsquo;t mean you don&rsquo;t need any infrastructure or
configuration. The good news is that, for the periodic job/cron usecase
this infrastructure is fairly standard between jobs.</p>

<p>Apex has <a href="http://apex.run/#managing-infrastructure">useful integration with Terraform</a>
to help manage any required infrastructure too. We can run the following
two commands to provision and then manage our infrastructure.</p>

<pre><code>apex infra init
apex infra deploy
</code></pre>

<p>Doing so requires us to write a little Terraform code. First we need
some variables, we&rsquo;ll invclude this in <code>infrastructure/variables.tf</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#080;font-weight:bold">variable</span> <span style="color:#d20;background-color:#fff0f0">&#34;aws_region&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">  description =</span> <span style="color:#d20;background-color:#fff0f0">&#34;AWS Region Lambda function is deployed to&#34;</span>
}<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">variable</span> <span style="color:#d20;background-color:#fff0f0">&#34;apex_environment&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">  description =</span> <span style="color:#d20;background-color:#fff0f0">&#34;Apex configured environment. Auto provided by &#39;apex infra&#39;&#34;</span>
}<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">variable</span> <span style="color:#d20;background-color:#fff0f0">&#34;apex_function_role&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">  description =</span> <span style="color:#d20;background-color:#fff0f0">&#34;Provisioned Lambda Role ARN via Apex. Auto provided by &#39;apex infra&#39;&#34;</span>
}<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">variable</span> <span style="color:#d20;background-color:#fff0f0">&#34;apex_function_hub&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">  description =</span> <span style="color:#d20;background-color:#fff0f0">&#34;Provisioned function &#39;hub&#39; ARN information. Auto provided by &#39;apex infra&#39;&#34;</span>
}<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">variable</span> <span style="color:#d20;background-color:#fff0f0">&#34;apex_function_hub_name&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">  description =</span> <span style="color:#d20;background-color:#fff0f0">&#34;Provisioned function &#39;hub&#39; name information. Auto provided by &#39;apex infra&#39;&#34;</span>
}</code></pre></div>
<p>And then we need to describe the resources for our cron job in
<code>infrastructure/main.tf</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#080;font-weight:bold">resource</span> <span style="color:#d20;background-color:#fff0f0">&#34;aws_cloudwatch_event_rule&#34; &#34;every_five_minutes&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">    name =</span> <span style="color:#d20;background-color:#fff0f0">&#34;every-five-minutes&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">description =</span> <span style="color:#d20;background-color:#fff0f0">&#34;Fires every five minutes&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">schedule_expression =</span> <span style="color:#d20;background-color:#fff0f0">&#34;rate(5 minutes)&#34;</span>
}<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">resource</span> <span style="color:#d20;background-color:#fff0f0">&#34;aws_cloudwatch_event_target&#34; &#34;check_hub_every_five_minutes&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">    rule =</span> <span style="color:#d20;background-color:#fff0f0">&#34;${aws_cloudwatch_event_rule.every_five_minutes.name}&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">target_id =</span> <span style="color:#d20;background-color:#fff0f0">&#34;${var.apex_function_hub_name}&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">arn =</span> <span style="color:#d20;background-color:#fff0f0">&#34;${var.apex_function_hub}&#34;</span>
}<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">resource</span> <span style="color:#d20;background-color:#fff0f0">&#34;aws_lambda_permission&#34; &#34;allow_cloudwatch_to_call_hub&#34;</span> {<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">    statement_id =</span> <span style="color:#d20;background-color:#fff0f0">&#34;AllowExecutionFromCloudWatch&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">action =</span> <span style="color:#d20;background-color:#fff0f0">&#34;lambda:InvokeFunction&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">function_name =</span> <span style="color:#d20;background-color:#fff0f0">&#34;${var.apex_function_hub_name}&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">principal =</span> <span style="color:#d20;background-color:#fff0f0">&#34;events.amazonaws.com&#34;</span>
    <span style="color:#a61717;background-color:#e3d2d2">source_arn =</span> <span style="color:#d20;background-color:#fff0f0">&#34;${aws_cloudwatch_event_rule.every_five_minutes.arn}&#34;</span>
}</code></pre></div>
<p>Here we&rsquo;re running the job every 5 minutes, but it should be relatively
easy to see how you can change that frequency. See the Terraform and AWS
Lambda documentation for all the possible options.</p>

<h2 id="on-complexity-user-interface-and-abstractions">On complexity, user interface and abstractions</h2>

<p>The above is undoutedly powerful, and nicely solves the described
probles with using Cron. However it&rsquo;s not all plain sailing I feel
with Serverless as a Cron replacement.</p>

<p>Let&rsquo;s talk about complexity. If I can make the assumptions that:</p>

<ul>
<li>The underlying host I was going to run my cron job on host is well managed,
potentially by another team in my organisation</li>
<li>Hosts don&rsquo;t suffer downtime, or if they do it&rsquo;s occasional and they
are brough back up quickly</li>
</ul>

<p>Then I can just use cron. And the interface to cron looks something more
like:</p>

<pre><code>*/5 * * * * /home/garethr/run.sh
</code></pre>

<p>I still had to write my function (the Clojure code above) but I
collapsed the configuration of three distinct AWS resources and the use of a
new tool (Terraform) into a one-line crontab entry. You might have
provisioned that cron job using Puppet or Chef which adds a few lines
and a new tool, which sits somewhere between hand editing and the above
example.</p>

<p>This is really a question of user interface design and abstractions.
On one hand Serverless provides a nice high-level shared abstraction for
developers (the function). On another Serverless requires a great deal
of (virtual) infrastructure, which at the moment tends not to be abstracted
from the end-user. In the simple case above I had to care about
<code>aws_cloudwatch_event_targets</code>, <code>aws_cloudwatch_event_rules</code> and
<code>aws_lambda_permissions</code>. The use of those non-abstract resources all
couples my simple cron example to a specific platform (AWS) when the
simple function could likely run on any Serverless platform that
supports the JVM.</p>

<h2 id="serverless-not-infrastructureless">Serverless, not Infrastructureless</h2>

<p>I&rsquo;m purposefully nit-picking with the above example. Serverless does
provide a more straightforward cron experience, mainly because it&rsquo;s
self-contained. But the user interface even for simple examples is still
very raw in many cases. Importantly, in removing the concept of ervers,
we don&rsquo;t appear to have removed the need to configure infrastructure,
which I think is what many people thing of when they hope to be rid of
servers in the first place.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/05/26/conference-speaking-as-a-software-vendor/">Conference speaking as a software vendor</a>
      </h1>
      <span class="post-date">May 26, 2017 &middot; 9 minute read
      </span>
      
      

<p>While reviewing 100s of proposals for upcoming conferences (Velocity EU and
PuppetConf) I tweeted <a href="https://twitter.com/garethr/status/863780750927286273">the
following</a>, which
seemed to get a few folks interest.</p>

<blockquote>
<p>I should write a blog post on &ldquo;conference talk submissions for
vendors/consultants&rdquo;. Rule one: own your bias</p>
</blockquote>

<p><a href="https://twitter.com/dparzych/status/864217466389405696">This reply</a> in
particular pushed me over the edge into actually writing this post:</p>

<blockquote>
<p>Would love to hear advice, been told more than once a talk was rejected
since I work for a vendor, even though my talk was not a pitch.</p>
</blockquote>

<p>Writing something up felt like it might be useful to a few folks so here
goes. This is but one persons opinion, but I at least have some relevant
experience:</p>

<ul>
<li>I&rsquo;ve worked for a software vendor for about 3 years</li>
<li>Before that I worked for the UK Government, and before that various
SaaS companies, in-house software teams and very briefly myself</li>
<li>I&rsquo;ve helped out on the programme committee or similar for a variety of
events going back a bunch of years; Velocity, PuppetConf, Lisa,
Devopsdays, QCon</li>
<li>I&rsquo;ve been lucky enough to speak at a wide range of events in lots of
different places</li>
</ul>

<p>Some of the following advice is pretty general, if you&rsquo;re interested in
speaking at software conferences (at least those I&rsquo;ve seen or spoken at)
then hopefully much of this is relevant to you. But I also want to focus on
people working for a software vendor. I think that&rsquo;s particularly
relevant as more and more traditional vendors court the open source
community and software developers inparticular, and roles like
<em>developer evangelist</em> see lots of people moving from more practioner
roles to work vendor-side.</p>

<h2 id="learn-to-write-a-good-proposal">Learn to write a good proposal</h2>

<p>My main experience with speaking at conferences, or helping currate
content, is via a call-for-proposals. The conference will have some
sort of theme or topic, set a date, and see what content is submitted.
Their are a variety of oft-made points here about sponsoring to get a
talk slot, or submitting early, or approaching the organisers, but in my
experience the best bet is to write a really good proposal around a good
idea. That&rsquo;s obviously easier said that done, but it&rsquo;s not as hard as
you may think.</p>

<ul>
<li>Introduce the problem you&rsquo;re talking about, but don&rsquo;t make
this the whole proposal.</li>
<li>State in the proposal what you&rsquo;re going to talk about. Be specific.
Don&rsquo;t say &ldquo;an open source tool&rdquo; when you mean a specific tool which
has a name. Don&rsquo;t hide the details of the talk because you intend to
reveal them when presenting.</li>
<li>Include explicitly what the audience will do or be able to do
differently after seeing the talk. Go so far as to say <em>&ldquo;after this
talk attendee will&hellip;&rdquo;</em></li>
<li>Novely really helps, as long as the topic is interesting and relevant.
Given 100 proposals about deploying your web application with Docker,
the one that says &ldquo;and we do this for the International Space Station&rdquo;
is getting picked.</li>
<li>If you know this is going to be a popular topic for other proposals
then you also need to confince the CFP committee why you&rsquo;re the best
person to present it.</li>
<li>Liberally use bullet points. This might be a personal thing but if I&rsquo;m
reading 200+ proposals making it quick to read helps get your point
across.</li>
</ul>

<p>Unless you write a good proposal around an interesting idea you probably
won&rsquo;t be accepted whether you&rsquo;re a software vendor or not. Try get
feedback on your proposals, especially from folks who have previously
spoken at the event you&rsquo;re hoping to present at.</p>

<h2 id="appreciate-you-re-selling-something">Appreciate you&rsquo;re selling something</h2>

<p>If you work for a software vendor your job is to sell software. Not
everyone likes that idea, but I think at least for the purposes of this
blog post it stands true. It doesn&rsquo;t matter if you&rsquo;re an evangelist
reporting into Marketing, or a software developer in Engineering or
anything else - you stand to gain directly or indirectly from people
purchasing your product. From the point of view of a conference you are
thoroughly compromised when it comes to talking about your product
directly. This can be disheartening as you likely work at the vendor
and want to talk at the conference because you&rsquo;re genuinely interested,
even evangelical, about the product. You need to own that bias - there
really is no way around it.</p>

<p>If you work for a vendor, and the CFP committee even thinks the proposal
is about that product, you&rsquo;ll probably not be given the benefit of
doubt.</p>

<h2 id="and-the-answers-is">And the answers is&hellip;</h2>

<p>Probably the worst example of vendor talks that do sometimes get
accepted go something like this:</p>

<ul>
<li>Introduce a problem people can relate to</li>
<li>Show some (probably open source) options for solving, focusing on the
large integration cost of tying them together</li>
<li>Conclude with the answer being the vendors all-in-one product</li>
</ul>

<p>I think for expo events or for sponsored slots this approach is totally
valid, but for a CFP it bugs me:</p>

<ul>
<li>The proposal probably didn&rsquo;t explain that the the answer was the
commercial product sold by the vendor</li>
<li>The talk is unlikely to cover like-for-like competition, for instance
it&rsquo;s probably not going to spend much time referring to direct
commercial competitors</li>
<li>As noted above, the presented is thoroughly biased, which doesn&rsquo;t make
for a great conference talk</li>
</ul>

<p>Please don&rsquo;t do this. It&rsquo;s a easy trap to fall into, mainly because you
hopefully genuinely believe in the product you&rsquo;re talking about and the
problem you&rsquo;re solving. If you really want talks like this try and
encourage your customers to give then - a real-world story version of
this is much more interesting.</p>

<h2 id="talk-about-the-expertise-rather-than-the-product">Talk about the expertise rather than the product</h2>

<p>It&rsquo;s not all doom for those working for software vendors and wanting to
talk at conferences. The reality is that while you&rsquo;re working on a
discrete product you&rsquo;re also likely spending a lot of time thinking about
a specific domain. I spent a bunch of years using Puppet as a product,
but I&rsquo;ve spent more time while working at Puppet thinking about the
nature of configuration, and about wildly heterogenuous systems. When I
worked for the Government I interacted with a handful of departments and
projects. At Puppet I&rsquo;ve spoken with 100s of customers, and read trip
reports on meetings with others. Working for a vendor gives you a
different view of what&rsquo;s going on, especially if you talk to people from
other departments.</p>

<p>In my experience, some of the best talks from those working for software
vendors can be quite meta, theoretical or future facing. You have the
dual benefit of working in a singular domain (so you can do deep) and
hopefully having access to lots customers (so you can go broad).</p>

<h2 id="talks-as-a-product-design-tool">Talks as a product design tool</h2>

<p>As someone working for a vendor, a big part of my job is designing and
building new features or new products. I&rsquo;ve regularly found giving talks
(including the time taken to think about the topic and put together the
demos and slides) to be a great design tool. Assuming you&rsquo;re already
doing research like this, even in the background, pitching a talk on the
subject has a few advantages:</p>

<ul>
<li>It starts you writing for a public audience early in the design
process</li>
<li>The talk being accepted, and the feedback from the talk, provide early
input into the design process</li>
<li>The talk (or published slides) can encourage people thinking about
similar things to get in touch</li>
</ul>

<p>You can see this if you flick through talks I&rsquo;ve given over the past few
years. For instance <a href="https://speakerdeck.com/garethr/whats-inside-that-container">What&rsquo;s inside that
container?</a>
and more recently <a href="https://speakerdeck.com/garethr/security-and-the-self-contained-unit-of-software">Security and the self-contained unit of software</a>
provide some of the conceptual underpinnings for
<a href="https://lumogon.com/">Lumogon</a>. And <a href="https://speakerdeck.com/garethr/the-dockerfile-explosion-and-the-need-for-higher-level-tools">The Dockerfile explosion - and the need for higher-level tools</a>
talk I gave at DockerCon led to the work on <a href="https://github.com/puppetlabs/puppetlabs-image_build">Puppet Image
Build</a>.</p>

<p>These talks all stand alone as (hopefully) useful and interesting
presentations, but also serve a parallel internal purpose which
importantly doesn&rsquo;t excert the same bias on the content.</p>

<h2 id="some-good-examples">Some good examples</h2>

<p>The above is hopefully useful theory, but I appreciate some people
prefer examples. The following include a bunch of talks I&rsquo;ve given at
various conference, with a bit of a rationale. I&rsquo;ve also picked out a
few examples of talks by other folks I respect that work at software
vendors and generally give excellent talks.</p>

<p>A great topic for most vendors to talk about at suitable conferences is
how they approach building software. I spoke about <a href="https://speakerdeck.com/garethr/in-praise-of-slow-continuous-delivery">In praise of slow
(Continuous
Delivery)</a>
at Pipeline conference recently, about how Puppet (and other vendors)
approach techniques like feature flags, continuous delivery and
versioning but for packaged software. That had novelty, as well as being
relevant to anyone involved with an open source project.</p>

<p>Probably my favourite talk I&rsquo;ve given in the last year,
<a href="https://speakerdeck.com/garethr/the-two-sides-to-google-infrastructure-for-everyone-else">The Two Sides to Google Infrastructure for Everyone Else</a>
looks at SRE, and infrastructure from two different vantage points.
This talk came directly from spending time with the container folks on
one hand, and far more traditional IT customers on the other, and
wondering if they meet in the middle.</p>

<p>Charity Majors is the CEO at Honeycomb and likes databases a lot more
than I do. The talk <a href="https://speakerdeck.com/charity/maslows-hierarchy-of-database-needs">Maslows Hierachy of Database Needs</a>
is just solid technical content from an expert on the subject. Closer to
the Honeycomb product is this talk
<a href="https://speakerdeck.com/charity/gluecon-2017-observability-and-the-glorious-future">Observability and the Glorious Future</a>,
but even this avoids falling into the trap described above and stays
focused on generally applicable areas to consider.</p>

<p>Jason Hand from VictorOps has given a number of talks about ChatOps,
including this one entitled <a href="https://speakerdeck.com/jasonhand/chatops-infrastructure-as-conversation">Infrastructure as Conversation</a>.
Note that some of the examples use VictorOps, but the specific tool
isn&rsquo;t the point of the talk. The abstract on the last slide is also a
neat idea.</p>

<p><a href="http://bridgetkromhout.com/">Bridget Kromhout</a> works for Pivotal, the
folks behind Cloud Foundry amongst other things. But she invariably
delivers some of the best big picture operations talks around. Take a
couple of recent examples <a href="http://bridgetkromhout.com/speaking/2017/monitorama/">I Volunteer as Tribute - the Future of Oncall</a>
and <a href="http://bridgetkromhout.com/speaking/2017/agile-technical/">Ops in the Time of Serverless Containerized Webscale</a>.
Neither talk is about a specific product, instead both mix big picture
transformation topics with hard-earned ops experience.</p>

<p>As a final point, all of those examples have interesting titles, which
comes back to the first point above. Make content that people really want
to listen to first, and if you&rsquo;re a vendor own your biases.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/03/29/kubernetes-configuration-without-the-yaml/">Kubernetes configuration without the YAML</a>
      </h1>
      <span class="post-date">Mar 29, 2017 &middot; 3 minute read
      </span>
      
      

<p>Tomorrow at KubeCon in Berlin I&rsquo;m running a birds-of-a-feather session to talk
about Kubernetes configuration. Specifically we&rsquo;ll be talking about whether
Kubernetes configuration benefits from a domain specific language. If you&rsquo;re
at the conference and this sounds interesting <a href="http://sched.co/9Tcc">come along</a>.</p>

<h2 id="the-problem">The problem</h2>

<p>The fact the programme committee accepted the session proposa is hopefully a good
indication that at least some other people in the community think this is an
interesting topic to discuss. I&rsquo;ve also had a number of conversations in person
and on the internet about similar areas.</p>

<p>There are a number of other traces of concerns with using YAML as the main user
interface to Kubernetes configuration. This comment from Brian Grant of Google on the
Kubernetes Config SIG mailing list for instance:</p>

<blockquote>
<p>We&rsquo;ve had a few complaints that YAML is ugly, error prone, hard to read, etc.
Are there any other alternatives we might want to support?</p>
</blockquote>

<p>And <a href="https://twitter.com/jbeda/status/833408476437110784">this one</a> from Joe Beda,
one of the creators of Kubernetes:</p>

<blockquote>
<p>I want to go on record: the amount of yaml required to do anything in k8s is a
tragedy. Something we need to solve. (Subtweeting HN comment)</p>
</blockquote>

<p>This quote from the <a href="http://queue.acm.org/detail.cfm?id=2898444">Borg, Omega and Kubernetes paper in ACM Queue, Volume 14, issue 1</a>
nicely sums up my feelings:</p>

<blockquote>
<p>The language to represent the data should be a simple, data-only format
such as JSON or YAML, and programmatic modification of this data should
be done in a real programming language</p>
</blockquote>

<p>This quote also points at the problem I see at the moment. The configuration and the
management of that configuration are <em>separate</em> but related concerns. Far too many
people couple these together, ultimately moving all of the management complexity
onto people. That&rsquo;s a missed opportunity in my view. The Kubernetes API is my
favourite think about the project, I&rsquo;ve waxed lyrical about it allowing for
different higher-level user interfaces for different users to all interact
on the same base platform. But treating what is basically the wire format
as a user interface is just needlessly messy.</p>

<p>But what advantages do we get using a programming language to modify the data?
For me it comes down to:</p>

<ul>
<li>Avoiding repetition</li>
<li>Combining external inputs</li>
<li>Building tools to enforce correctness (linting, unit testing, etc.)</li>
<li>The abililty to introduce abstractions</li>
</ul>

<p>It&rsquo;s the last part I find most compelling. Building things to allow others
to interact with a smaller domain specific abstraction is one way of scaling
expertise. The infrastructure as code space I&rsquo;ve been involved in has lots of
stories to tell around different good (and bad) ways of mixing data with code,
but the idea that data on it&rsquo;s own is enough without higher-level abstractions
doesn&rsquo;t hold up in my experience.</p>

<h2 id="what-can-i-use-instead">What can I use instead?</h2>

<p>Lukily various people at this point have build tools in this space. I&rsquo;m not sure
could or should be a single answer to the question (whether there should be a
default is a harder question to answer) but the following definitely all show
what&rsquo;s possible.</p>

<ul>
<li><a href="http://jsonnet.org/">Jsonnet</a></li>
<li><a href="https://github.com/anguslees/kubecfg">kubecfg</a></li>
<li><a href="https://github.com/garethr/garethr-kubernetes">Puppet Kubernetes types</a></li>
<li><a href="https://github.com/errordeveloper/kubeplay">Kubeplay</a></li>
<li><a href="https://github.com/maxmanuylov/terraform-provider-kubernetes">Terraform</a></li>
<li><a href="https://github.com/fkorotkov/k8s-kotlin-dsl">Kotlin DSL</a></li>
<li><a href="https://github.com/doriordan/skuber">Skuber</a> (Scala DSL for Kubernetes)</li>
</ul>

<p>Obviously <a href="https://puppet.com/blog/managing-kubernetes-configuration-puppet">I wrote one of these</a>
so I&rsquo;m biased but different tools work for different people and in different
contexts. For example Skuber looks nice but I mainly don&rsquo;t like Scala. And
I&rsquo;ve been using Jsonnet for Packer templates recently with success, so I&rsquo;m
very interested in kubecfg which provides a nice Kubernetes wrapper to that
tool.</p>

<p>Ultimately this is still a developing space, but compared to a year ago it is
now definitely moving. For me, I hope the default for managing Kubernetes
configuration slowly but surely switches away from just hand rolling data.
Towards what, only time and people reporting what works for them will tell.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/01/01/republishing-service-manual-content/">Republishing service manual content</a>
      </h1>
      <span class="post-date">Jan 1, 2017 &middot; 2 minute read
      </span>
      
      <p>One of the many things I did some work on while at
<a href="https://gds.blog.gov.uk/">GDS</a> back in 2013 was the <a href="https://www.gov.uk/service-manual">Government Service Design
Manual</a>. This was intended to be a
central resource for teams across (and outside) Government about how to
go about building, designing and running modern internet-era services.
It was a good snapshot of opinions from the people that made up GDS on a
wide range of different topics. Especially for the people who spent time
in the field with other departments, having an official viewpoint published
publicly was hugely helpful.</p>

<p>Recently the Service Manual <a href="https://gds.blog.gov.uk/2016/12/19/introducing-the-next-stage-of-the-service-manual/">got a bit of a relaunch</a>
but unfortunately this involved deleting much of the content about
operations and running a service. Even more unfortunately the service
manual is now described as something that:</p>

<blockquote>
<p>exists to help people across government build services that meet the
Digital Service Standard and prepare for service assessments.</p>
</blockquote>

<p>So in basic terms it&rsquo;s refocusing on helping people pass the exam rather
than being all about learning. Which is a shame. Compare that with the
original intent:</p>

<blockquote>
<p>Build services so good that people prefer to use them</p>
</blockquote>

<p>However, all that content is not lost. Luckily the content is <a href="https://github.com/alphagov/government-service-design-manual">archived on GitHub</a>
and was published under the terms of the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/">Open Government License</a>
which allows for anyone to <em>&ldquo;copy, publish, distribute and transmit the Information&rdquo;</em>.
So I&rsquo;m choosing to republish a few of the pieces I wrote and found
useful when talking to and assisting other Government departments. These
represent an interesting snapshot from a few years ago, but I think
mainly stand the test of time, even if I&rsquo;d change a few things if I
wrote them today.</p>

<ul>
<li><a href="https://www.morethanseven.net/2017/01/01/what-is-devops/">What is
Devops?</a></li>
<li><a href="https://www.morethanseven.net/2017/01/01/agile-and-it-service-management/">Agile and IT Service Management</a></li>
<li><a href="https://www.morethanseven.net/2017/01/01/user-stories-for-web-operations/">User stories for web operations teams</a></li>
</ul>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/01/01/what-is-devops/">What is Devops?</a>
      </h1>
      <span class="post-date">Jan 1, 2017 &middot; 4 minute read
      </span>
      
      

<p><em>This post was originally written as part of the Government Service
Design Manual while I was working for the UK Cabinet Office. Since my
original in 2013 it was improved upon <a href="https://github.com/alphagov/government-service-design-manual/blob/master/service-manual/operations/devops.md">by several
others</a>
I&rsquo;m republishing it here under the terms of the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/">Open Government
licence</a>.</em></p>

<p>Devops is a cultural and professional movement in response to the
mistakes commonly made by large organisations. Often organisations will
have very separate units for:</p>

<ul>
<li>development</li>
<li>quality assurance</li>
<li>operations business</li>
</ul>

<p>In extreme cases these units may be:</p>

<ul>
<li>based in different locations</li>
<li>work for different organisations</li>
<li>under completely different management structures</li>
</ul>

<p>Communication costs between these units, and their individual
incentives, leads to slow delivery and a mountain of interconnected
processes.</p>

<p>This is what Devops aims to correct. It is not a methodology or
framework, but a set of principles and a willingness to break down
silos. Specifically Devops is all about:</p>

<ul>
<li><a href="#culture">culture</a></li>
<li><a href="#automation">automation</a></li>
<li><a href="#measurement">measurement</a></li>
<li><a href="#sharing">sharing</a></li>
</ul>

<h3 id="culture">Culture</h3>

<p>Devops needs a change in attitude so shared ownership and collaboration
are the common working practices in building and managing a service.
This culture change is especially important for established
organisations.</p>

<h3 id="automation">Automation</h3>

<p>Many business processes are ready to be automated. Automation removes
manual, error-prone tasks &ndash; allowing people to concentrate on the
quality of the service. Common areas that benefit from automation are:</p>

<ul>
<li>release management (releasing software)</li>
<li>provisioning</li>
<li>configuration management</li>
<li>systems integration</li>
<li>monitoring</li>
<li>orchestration (the arrangement and maintenance of complex computer
systems)</li>
<li>testing</li>
</ul>

<h3 id="measurement">Measurement</h3>

<p>Data can be incredibly powerful for implementing change, especially when
it’s used to get people from different groups involved in the quality of
the end-to-end service delivery. Collecting information from different
teams and being able to compare it across former silos can implement
change on its own.</p>

<h3 id="sharing">Sharing</h3>

<p>People from different backgrounds (ie development and operations) often
have different, but overlapping skill sets. Sharing between groups will
spread an understanding of the different areas behind a successful
service, so encourage it. Resolving issues will then be more about
working together and not negotiating contracts.</p>

<h2 id="why-devops">Why Devops</h2>

<p>The quality of your service will be compromised if teams can&rsquo;t work
together, specifically:</p>

<ul>
<li>those who build and test software</li>
<li>those that run it in production</li>
</ul>

<p>The root cause is often functional silos; when one group owns a specific
area (say quality) it’s easy for other areas to assume that it’s no
longer their concern.</p>

<p>This attitude is toxic, especially in areas such as:</p>

<ul>
<li>quality</li>
<li>release management</li>
<li>performance</li>
</ul>

<p>High quality digital services need to be able to adapt quickly to user
needs, and this can only happen with close collaboration between
different groups.</p>

<p>Make sure the groups in your team:</p>

<ul>
<li>have a shared sense of ownership of the service</li>
<li>have a shared sense of the problem</li>
<li>develop a culture of making measurable improvements to how things work</li>
</ul>

<h2 id="good-habits">Good habits</h2>

<p>Devops isn’t a project management methodology, but use these good habits
in your organisation. While not unique to Devops, they help with
breaking down silos when used with the above principles:</p>

<ul>
<li>cross-functional teams &ndash; make sure your
teams are made up of people from different functions (this helps with
the team owning the end-to-end quality of service and makes it easier to
break down silos)</li>
<li>widely shared metrics &ndash; it’s important
for everyone to know what ‘good’ looks like so share high and low
level metrics as widely as possible as it builds understanding</li>
<li>automating repetitive tasks &ndash; use software development to automate
tasks across the service as it:

<ul>
<li>encourages a better understanding of the whole service</li>
<li>frees up smart people from doing repetitive manual tasks</li>
</ul></li>
<li>post-mortems &ndash; issues will happen so it’s critical that everyone
across different teams learns from them; running post-mortems (an
analysis session after an event) with people from different groups is a
great way of spreading knowledge</li>
<li>regular releases
&ndash; the capacity for releasing software is often limited in siloed
organisations, because the responsibilities of the different parts of
the release are often spread out across teams &ndash; getting to a point
where you can release regularly (even many times a day) requires extreme
collaboration and clever automation</li>
</ul>

<h2 id="warning-signs">Warning signs</h2>

<p>Like agile, the term Devops is often used for marketing or promotional
purposes. This leads to a few common usages, which aren’t necessarily in
keeping with what’s been said here. Watch out for:</p>

<ul>
<li>Devops tools (nearly always marketing)</li>
<li>a Devops team (in many cases this is just a new silo of skills and
knowledge)</li>
<li>Devops as a job title (you wouldn’t call someone “an agile”)</li>
</ul>

<h2 id="further-reading">Further reading</h2>

<ul>
<li><a href="https://www.chef.io/blog/2010/07/16/what-devops-means-to-me/">What Devops Means to
Me</a></li>
<li><a href="http://www.jedi.be/blog/2010/02/12/what-is-this-devops-thing-anyway/">What is this Devops thing
anyway?</a></li>
<li><a href="http://dev2ops.org/2010/02/what-is-devops/">What is Devops? (and the wall of
confusion)</a></li>
<li><a href="http://continuousdelivery.com/2012/10/theres-no-such-thing-as-a-devops-team/">There’s no such thing as a &ldquo;Devops
Team&rdquo;</a></li>
</ul>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="/2017/01/01/agile-and-it-service-management/">Agile and IT service management</a>
      </h1>
      <span class="post-date">Jan 1, 2017 &middot; 6 minute read
      </span>
      
      

<p><em>This post was originally written as part of the Government Service
Design Manual while I was working for the UK Cabinet Office. Since my
original in 2013 it was improved upon <a href="https://github.com/alphagov/government-service-design-manual/blob/master/service-manual/operations/service-management.md">by several
others</a>
I&rsquo;m republishing it here under the terms of the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/">Open Government
licence</a>.</em></p>

<p>The Digital by Default standard
says that organisations should (emphasis on <em>operate</em> added):</p>

<blockquote>
<p>Put in place a sustainable multidisciplinary team that can design, build
and <em>operate</em> the service, led by a suitably skilled and senior service manager
with decision-making responsibility.</p>
</blockquote>

<p>This implies a change to how many organisations have traditionally run services,
often with a team or organisation building a service separate from the one running it.
This change however does not mean ignoring existing good practice when it comes to service
management.</p>

<h2 id="agile-and-service-management">Agile and service management</h2>

<p>The principles of IT service management (ITSM) and those of agile do not necessarily
conflict &ndash; issues can arise however when organisations implement rigid processes
without considering wider service delivery matters, or design and build services
without thinking about how they will be operated.</p>

<p>The <a href="http://agilemanifesto.org/">agile manifesto</a> makes the case for:</p>

<ul>
<li>Individuals and interactions over processes and tools</li>
<li>Working software over comprehensive documentation</li>
<li>Customer collaboration over contract negotiation</li>
<li>Responding to change over following a plan</li>
</ul>

<p>It is too easy to position service management as opposed to agile as
traditional service management practices can be viewed as focusing on processes, tools,
documentation, planning and contract negotiation &ndash; the items on the right hand
side of the points above.</p>

<p>However, the agile manifesto goes on to say:</p>

<blockquote>
<p>That is, while there is value in the items on the right, we
value the items on the left more.</p>
</blockquote>

<p>To build and run a successful service you will need to work on suitable
processes and manage third party relationships. Using existing service management
frameworks (especially as a starting point) is one approach to this problem.</p>

<h2 id="itil">ITIL</h2>

<p><a href="https://www.axelos.com/itil">ITIL</a> (the Information Technology Infrastructure
Library) is one such framework. ITIL does a particularly good job of facilitating shared
language. For instance it&rsquo;s definition of a service is:</p>

<blockquote>
<p>A service is a means of delivering value to customers by facilitating outcomes
customers want to achieve.</p>
</blockquote>

<p>The current version of ITIL currently provides 5 volumes and 26 processes
describing in detail various aspects of service management:</p>

<h3 id="service-strategy">Service Strategy</h3>

<ul>
<li>IT service management</li>
<li>Service portfolio management</li>
<li>Financial management for IT services</li>
<li>Demand management</li>
<li>Business relationship management</li>
</ul>

<h3 id="service-design">Service Design</h3>

<ul>
<li>Design coordination</li>
<li>Service Catalogue management</li>
<li>Service level management</li>
<li>Availability management</li>
<li>Capacity Management</li>
<li>IT service continuity management</li>
<li>Information security management system</li>
<li>Supplier management</li>
</ul>

<h3 id="service-transition">Service Transition</h3>

<ul>
<li>Transition planning and support</li>
<li>Change management</li>
<li>Service asset and configuration management</li>
<li>Release and deployment management</li>
<li>Service validation and testing</li>
<li>Change evaluation</li>
<li>Knowledge management</li>
</ul>

<h3 id="service-operation">Service Operation</h3>

<ul>
<li>Event management</li>
<li>Incident management</li>
<li>Request fulfillment</li>
<li>Problem management</li>
<li>Identity management</li>
</ul>

<h3 id="continual-service-improvement">Continual Service Improvement</h3>

<h3 id="functions">Functions</h3>

<p>ITIL also describes four functions that should cooperate together to form
an effective service management capability.</p>

<ul>
<li>Service operations</li>
<li>Technical management</li>
<li>Application management</li>
<li>Operations management</li>
</ul>

<h2 id="the-importance-of-implementation">The importance of implementation</h2>

<p>The above processes and functions make for an excellent high level list of topics
to discuss when establishing an operating model for your service, whether
or not you adopt the formal methods. In many cases if you have well understood,
well established and well documented processes in place for all of the above
you should be in a good position to run your service.</p>

<p>When looking to combine much of the rest of the guidance on the service manual
with ITIL or other service management frameworks it is important to challenge
existing implementations. This is less about the actual implementation and more often
about the problems that implementation was designed to originally solve.</p>

<h3 id="an-example-service-transition">An example &ndash; service transition</h3>

<p>As an example ITIL talks a great deal about Service Transition &ndash; getting working functionality
into the hands of the users of the service. This is a key topic for The Digital Service Standard
too which says that teams should:</p>

<blockquote>
<p>Make sure that you have the capacity and technical flexibility to update and
improve the service on a very frequent basis.</p>
</blockquote>

<p><a href="https://www.gov.uk">GOV.UK</a> for instance made more than 100 production releases
<a href="https://gds.blog.gov.uk/2012/11/02/regular-releases-reduce-risk/">during its first two weeks</a> after launch.</p>

<p>This high rate of change tends to challenge existing processes designed for a
slower rate of change. If you are releasing your service every month or every 6 months
then a manual process (like a weekly or monthly in-person change approval board or CAB) may be
the most suitable approach. If you&rsquo;re releasing many times a day then the approach to how
change is evaluated, tested and managed tends towards being more automated. This
moves effort from occasional but manual activities to upfront design and automation
work. More work is put in to assure the processes rather than putting all the effort
into assuring a specific <em>transition</em>.</p>

<p>Service management frameworks tend to acknowledge this, for instance ITIL has a
concept of a standard change (something commonly done, with known risks
and hence pre-approved), but a specific implementation in a given organisation
might not.</p>

<h2 id="other-frameworks-exist">Other frameworks exist</h2>

<p>It is important to note that other service management frameworks and standards
exist, including some that are of a similar size and scope to ITIL:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/ISO/IEC_20000">ISO/IEC 20000</a></li>
<li><a href="https://www.microsoft.com/MOF">Microsoft Operations Framework</a></li>
</ul>

<p>Many organisations also use smaller processes and integrate them together.
The needs of your service and organisation will determine what works best for you.</p>

<h2 id="problematic-concepts">Problematic concepts</h2>

<p>Some traditional language tends to cause some confusion when discussing service
management alongside agile. It&rsquo;s generally best to avoid the following terms when possible,
although given their widespread usage this isn&rsquo;t always possible. It is however worth
being aware of the problems these concepts raise.</p>

<h3 id="projects">Projects</h3>

<p>Projects tend to imply a start and an end. The main goal of project work is to
complete it, to reach the end. Especially for software development the project can
too often be viewed as <em>done</em> when the software is released. What happens after that
is another problem entirely &ndash; and often someone else&rsquo;s problem.</p>

<p>However when building services the main goal is to meet user needs
These needs may change over time, and are only met by software that is running in
production and available to those users.</p>

<p>This doesn&rsquo;t mean not breaking work down into easily understandable parts, but stories,
sprints and epics are much more
suited to agile service delivery.</p>

<h3 id="business-as-usual">Business as usual</h3>

<p>The concept of business as usual also clashes with a model of continuous
service improvement. It immediately brings to mind before and after
states, often with the assumption that change is both much slower and
more constrained during <em>business as usual</em>. In reality, until you put your
service in the hands of real users as part of an alpha
or beta you won&rsquo;t have all the information
needed to build the correct service. And even once you pass the live standard
you will be expected to:</p>

<blockquote>
<p>continuously update and improve the service on the basis of user feedback,
performance data, changes to best practice and service demand</p>
</blockquote>

<h2 id="further-reading">Further reading</h2>

<ul>
<li><a href="http://www.slideshare.net/nuwulang/functions-in-service-operation">Functions in service management</a></li>
<li><a href="https://en.wikipedia.org/wiki/ITIL">ITIL on Wikipedia</a></li>
<li><a href="http://www.best-management-practice.com/gempdf/itsmf_an_introductory_overview_of_itil_v3.pdf">Introduction to ITIL v3</a></li>
<li><a href="http://blog.ingineering.it/post/59414765140/itil-vs-devops-slugfest-or-lovefest">Discussion of Devops and ITIL</a></li>
<li><a href="http://changeandrelease.com/2014/04/05/devops-and-itil-continuous-delivery-doesnt-stop-at-software/">Discussion of ITIL and Continuous Delivery</a></li>
</ul>

      
    </div>
    
    

<ul class="pagination">
    
    <li class="page-item">
        <a href="/" class="page-link" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li class="page-item disabled">
    <a href="" class="page-link" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item active"><a class="page-link" href="/">1</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/2/">2</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/3/">3</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item disabled"><span aria-hidden="true">&nbsp;&hellip;&nbsp;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/43/">43</a></li>
    
    
    <li class="page-item">
    <a href="/page/2/" class="page-link" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li class="page-item">
        <a href="/page/43/" class="page-link" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>

  </div>
</div>



</body>
</html>

